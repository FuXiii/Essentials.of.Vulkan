<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../../genindex.html" /><link rel="search" title="搜索" href="../../search.html" /><link rel="next" title="VK_KHR_ray_tracing_pipeline" href="VK_KHR_ray_tracing_pipeline.html" /><link rel="prev" title="Vulkan KHR 光线追踪标准" href="VulkanKHRRayTracing.html" />
        <link rel="canonical" href="https://github.com/FuXiii/Essentials.of.Vulkan/InformalEssay/VulkanKHRRayTracing/VK_KHR_acceleration_structure.html" />

    <link rel="shortcut icon" href="../../_static/VulkanLogo.png"/><!-- Generated with Sphinx 7.2.6 and Furo 2023.09.10 -->
        <title>VK_KHR_acceleration_structure - Vulkan入门精要</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b20cc3f5" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    
    


<style>
  body {
    --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Vulkan入门精要</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
<div class="sidebar-sticky" ><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/Vulkan.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Vulkan入门精要</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">入门精要</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../StartFromVulkanSDK.html">开始于 Vulkan SDK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../EnvironmentalConfig.html">环境配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">纵览</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">文献翻译</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Literature/index.html">文献</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 文献</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../Literature/VulkanRayTracingFinalSpecificationRelease.html">Vulkan 光线追踪最终标准发布</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Literature/Vulkan-GuideRayTracing.html">光线追踪</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../Literature/NVIDIAVulkanRayTracingTutorial/NVIDIAVulkanRayTracingTutorial.html">NVIDIA Vulkan 光线追踪教程</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of NVIDIA Vulkan 光线追踪教程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../Literature/NVIDIAVulkanRayTracingTutorial/extensions/JitterCamera.html">相机抖动抗锯齿教程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Literature/NVIDIAVulkanRayTracingTutorial/extensions/AnyHitShaders.html">任意命中着色器（Any Hit Shaders）教程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Literature/NVIDIAVulkanRayTracingTutorial/extensions/Instances.html">实例化</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Literature/NVIDIAVulkanRayTracingTutorial/extensions/Reflections.html">反射</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Literature/NVIDIAVulkanRayTracingTutorial/extensions/MultipleClosestHitShaders.html">多重最近命中着色器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Literature/NVIDIAVulkanRayTracingTutorial/extensions/Animation.html">动态更新</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../Literature/vk_mini_path_tracer.html">Vulkan迷你路径追踪</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Literature/TheRTXShaderBindingTableThreeWays.html">RTX 着色器绑定表的三种方式</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">随笔</span></p>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">Vulkan 标准</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Vulkan 标准</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current has-children"><a class="reference internal" href="VulkanKHRRayTracing.html">Vulkan KHR 光线追踪标准</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Vulkan KHR 光线追踪标准</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">VK_KHR_acceleration_structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="VK_KHR_ray_tracing_pipeline.html">VK_KHR_ray_tracing_pipeline</a></li>
<li class="toctree-l3"><a class="reference internal" href="VK_KHR_deferred_host_operations.html">VK_KHR_deferred_host_operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="ShaderBindingTable.html">着色器绑定表</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../VK_KHR_buffer_device_address.html">VK_KHR_buffer_device_address</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">工程应用</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Application/index.html">应用</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of 应用</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../Application/VolumetricCloud.html">体积云</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Application/WebGPUImGui.html">WebGPU ImGui</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Application/WebGPUHelloTriangle.html">WebGPU Hello Triangle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Application/WebGPUShaderCompiler.html">WebGPU Shader Compiler</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">更新日志</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Changelog.html">更新日志</a></li>
</ul>

</div>
</div>

</div>

    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/FuXiii/Essentials.of.Vulkan/edit/main/source/InformalEssay/VulkanKHRRayTracing/VK_KHR_acceleration_structure.rst" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="vk-khr-acceleration-structure">
<h1>VK_KHR_acceleration_structure<a class="headerlink" href="#vk-khr-acceleration-structure" title="Link to this heading">#</a></h1>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header sd-bg-muted sd-bg-text-muted">
<span class="sd-summary-icon"><svg version="1.1" width="1.0em" height="1.0em" class="sd-octicon sd-octicon-history" viewBox="0 0 16 16" aria-hidden="true"><path fill-rule="evenodd" d="M1.643 3.143L.427 1.927A.25.25 0 000 2.104V5.75c0 .138.112.25.25.25h3.646a.25.25 0 00.177-.427L2.715 4.215a6.5 6.5 0 11-1.18 4.458.75.75 0 10-1.493.154 8.001 8.001 0 101.6-5.684zM7.75 4a.75.75 0 01.75.75v2.992l2.028.812a.75.75 0 01-.557 1.392l-2.5-1A.75.75 0 017 8.25v-3.5A.75.75 0 017.75 4z"></path></svg></span>更新记录<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<ul class="simple">
<li><p class="sd-card-text">2023/6/13 创建该文档</p></li>
<li><p class="sd-card-text">2023/6/13 将 <code class="docutils literal notranslate"><span class="pre">Vulkan</span> <span class="pre">KHR</span> <span class="pre">光线追踪标准</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">VK_KHR_acceleration_structure</span></code> 内容摘录于此</p></li>
<li><p class="sd-card-text">2023/6/13 更新 <code class="docutils literal notranslate"><span class="pre">拷贝加速结构</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/13 增加 <code class="docutils literal notranslate"><span class="pre">vkCmdWriteAccelerationStructuresPropertiesKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/14 更新 <code class="docutils literal notranslate"><span class="pre">vkCmdWriteAccelerationStructuresPropertiesKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/14 增加 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/14 增加 <code class="docutils literal notranslate"><span class="pre">VkCopyAccelerationStructureInfoKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/14 增加 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureToMemoryKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/15 更新 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureToMemoryKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/15 修改 <code class="docutils literal notranslate"><span class="pre">获取64位加速结构设备地址</span></code> 章节顺序</p></li>
<li><p class="sd-card-text">2023/6/15 增加 <code class="docutils literal notranslate"><span class="pre">VkCopyAccelerationStructureToMemoryInfoKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/15 增加 <code class="docutils literal notranslate"><span class="pre">vkGetDeviceAccelerationStructureCompatibilityKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/15 增加 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureVersionInfoKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/15 增加 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureCompatibilityKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/15 修改 <code class="docutils literal notranslate"><span class="pre">销毁加速结构</span></code> 章节顺序</p></li>
<li><p class="sd-card-text">2023/6/15 增加 <code class="docutils literal notranslate"><span class="pre">加速结构的</span> <span class="pre">Host</span> <span class="pre">端操作</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/19 更新 <code class="docutils literal notranslate"><span class="pre">加速结构的</span> <span class="pre">Host</span> <span class="pre">端操作</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/19 增加 <code class="docutils literal notranslate"><span class="pre">vkBuildAccelerationStructuresKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/19 增加 <code class="docutils literal notranslate"><span class="pre">vkCopyAccelerationStructureKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/19 增加 <code class="docutils literal notranslate"><span class="pre">vkCopyAccelerationStructureToMemoryKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/19 增加 <code class="docutils literal notranslate"><span class="pre">vkWriteAccelerationStructuresPropertiesKHR</span></code> 章节</p></li>
<li><p class="sd-card-text">2023/6/21 修改 <code class="docutils literal notranslate"><span class="pre">VK_KHR_device_group_creation</span></code> 将 <code class="docutils literal notranslate"><span class="pre">device扩展</span></code> 修改成 <code class="docutils literal notranslate"><span class="pre">instance扩展</span></code></p></li>
</ul>
</div>
</details><div class="important admonition">
<p class="admonition-title">加速结构的创建和构建</p>
<p>加速结构中经常能看到 <code class="docutils literal notranslate"><span class="pre">创建</span></code> 和 <code class="docutils literal notranslate"><span class="pre">构建</span></code> 的字样，这是两个不同的概念。加速结构的创建指的是创建加速结构句柄 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureKHR</span></code> ，在创建时可以不指定其内部的具体数据，可以先创建。对于加速结构的构建指的是构建加速结构内部真正的数据和结构，具体内部结构是什么形式的是驱动内部自定义的（一种可能的结构为 <code class="docutils literal notranslate"><span class="pre">BVH</span></code> ）。</p>
</div>
<p>该扩展属于 <span class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info">device扩展</span>。</p>
<p><span class="sd-sphinx-override sd-badge sd-bg-primary sd-bg-text-primary">依赖如下</span></p>
<ul class="simple">
<li><p>Vulkan 1.1</p></li>
<li><dl class="simple">
<dt><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap54.html#VK_EXT_descriptor_indexing">VK_EXT_descriptor_indexing</a> <span class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info">device扩展</span> <span class="sd-sphinx-override sd-badge sd-bg-warning sd-bg-text-warning">在Vulkan 1.2中被纳入核心</span> <span class="sd-sphinx-override sd-badge sd-bg-primary sd-bg-text-primary">依赖如下</span></dt><dd><ul>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap54.html#VK_KHR_get_physical_device_properties2">VK_KHR_get_physical_device_properties2</a> <span class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info">instance扩展</span> <span class="sd-sphinx-override sd-badge sd-bg-warning sd-bg-text-warning">在Vulkan 1.1中被纳入核心</span></p></li>
<li><dl class="simple">
<dt><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap54.html#VK_KHR_maintenance3">VK_KHR_maintenance3</a> <span class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info">device扩展</span> <span class="sd-sphinx-override sd-badge sd-bg-warning sd-bg-text-warning">在Vulkan 1.1中被纳入核心</span> <span class="sd-sphinx-override sd-badge sd-bg-primary sd-bg-text-primary">依赖如下</span></dt><dd><ul>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap54.html#VK_KHR_get_physical_device_properties2">VK_KHR_get_physical_device_properties2</a> <span class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info">instance扩展</span> <span class="sd-sphinx-override sd-badge sd-bg-warning sd-bg-text-warning">在Vulkan 1.1中被纳入核心</span></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap54.html#VK_KHR_buffer_device_address">VK_KHR_buffer_device_address</a> <span class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info">device扩展</span> <span class="sd-sphinx-override sd-badge sd-bg-warning sd-bg-text-warning">在Vulkan 1.2中被纳入核心</span> <span class="sd-sphinx-override sd-badge sd-bg-primary sd-bg-text-primary">依赖如下</span></dt><dd><ul>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap54.html#VK_KHR_get_physical_device_properties2">VK_KHR_get_physical_device_properties2</a> <span class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info">instance扩展</span> <span class="sd-sphinx-override sd-badge sd-bg-warning sd-bg-text-warning">在Vulkan 1.1中被纳入核心</span></p></li>
<li><dl class="simple">
<dt><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap54.html#VK_KHR_device_group">VK_KHR_device_group</a> <span class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info">device扩展</span> <span class="sd-sphinx-override sd-badge sd-bg-warning sd-bg-text-warning">在Vulkan 1.1中被纳入核心</span> <span class="sd-sphinx-override sd-badge sd-bg-primary sd-bg-text-primary">依赖如下</span></dt><dd><ul>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap54.html#VK_KHR_device_group_creation">VK_KHR_device_group_creation</a> <span class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info">instance扩展</span> <span class="sd-sphinx-override sd-badge sd-bg-warning sd-bg-text-warning">在Vulkan 1.1中被纳入核心</span></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap54.html#VK_KHR_deferred_host_operations">VK_KHR_deferred_host_operations</a> <span class="sd-sphinx-override sd-badge sd-bg-info sd-bg-text-info">device扩展</span></p></li>
</ul>
<p>新添加的对象类型（句柄）：</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap12.html#VkAccelerationStructureKHR">VkAccelerationStructureKHR</a></p></li>
</ul>
</div></blockquote>
<p>新添加的函数：</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkBuildAccelerationStructuresKHR">vkBuildAccelerationStructuresKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkCmdBuildAccelerationStructuresIndirectKHR">vkCmdBuildAccelerationStructuresIndirectKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkCmdBuildAccelerationStructuresKHR">vkCmdBuildAccelerationStructuresKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkCmdCopyAccelerationStructureKHR">vkCmdCopyAccelerationStructureKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkCmdCopyAccelerationStructureToMemoryKHR">vkCmdCopyAccelerationStructureToMemoryKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkCmdCopyMemoryToAccelerationStructureKHR">vkCmdCopyMemoryToAccelerationStructureKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkCmdWriteAccelerationStructuresPropertiesKHR">vkCmdWriteAccelerationStructuresPropertiesKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkCopyAccelerationStructureKHR">vkCopyAccelerationStructureKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkCopyAccelerationStructureToMemoryKHR">vkCopyAccelerationStructureToMemoryKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkCopyMemoryToAccelerationStructureKHR">vkCopyMemoryToAccelerationStructureKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap12.html#vkCreateAccelerationStructureKHR">vkCreateAccelerationStructureKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap12.html#vkDestroyAccelerationStructureKHR">vkDestroyAccelerationStructureKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap12.html#vkGetAccelerationStructureBuildSizesKHR">vkGetAccelerationStructureBuildSizesKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap12.html#vkGetAccelerationStructureDeviceAddressKHR">vkGetAccelerationStructureDeviceAddressKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkGetDeviceAccelerationStructureCompatibilityKHR">vkGetDeviceAccelerationStructureCompatibilityKHR</a></p></li>
<li><p><a class="reference external" href="https://registry.khronos.org/vulkan/specs/1.3-extensions/html/chap37.html#vkWriteAccelerationStructuresPropertiesKHR">vkWriteAccelerationStructuresPropertiesKHR</a></p></li>
</ul>
</div></blockquote>
<section id="id3">
<h2>查看是否支持加速结构特性<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>如果使用 <code class="docutils literal notranslate"><span class="pre">Vulkan</span> <span class="pre">1.1</span></code> 标准，可以通过调用 <code class="docutils literal notranslate"><span class="pre">vkGetPhysicalDeviceFeatures2</span></code> 获取加速结构特性相关信息。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 Vulkan 1.1 提供</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vkGetPhysicalDeviceFeatures2</span><span class="p">(</span>
<span class="n">VkPhysicalDevice</span><span class="w">                            </span><span class="n">physicalDevice</span><span class="p">,</span>
<span class="n">VkPhysicalDeviceFeatures2</span><span class="o">*</span><span class="w">                  </span><span class="n">pFeatures</span><span class="p">);</span>
</pre></div>
</div>
<p>如果激活了 <code class="docutils literal notranslate"><span class="pre">VK_KHR_get_physical_device_properties2</span></code> 扩展，可以通过 <code class="docutils literal notranslate"><span class="pre">vkGetPhysicalDeviceFeatures2KHR</span></code> 获取。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_get_physical_device_properties2 提供</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vkGetPhysicalDeviceFeatures2KHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkPhysicalDevice</span><span class="w">                            </span><span class="n">physicalDevice</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkPhysicalDeviceFeatures2</span><span class="o">*</span><span class="w">                  </span><span class="n">pFeatures</span><span class="p">);</span>
</pre></div>
</div>
<p>对于获取设备是否支持加速结构特性，是通过将 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructureFeaturesKHR</span></code> 的指针包含在 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceFeatures2::pNext</span></code> 指针链中。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 Vulkan 1.1 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkPhysicalDeviceFeatures2</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">             </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w">                       </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkPhysicalDeviceFeatures</span><span class="w">    </span><span class="n">features</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkPhysicalDeviceFeatures2</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkPhysicalDeviceAccelerationStructureFeaturesKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">    </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w">              </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkBool32</span><span class="w">           </span><span class="n">accelerationStructure</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkBool32</span><span class="w">           </span><span class="n">accelerationStructureCaptureReplay</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkBool32</span><span class="w">           </span><span class="n">accelerationStructureIndirectBuild</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkBool32</span><span class="w">           </span><span class="n">accelerationStructureHostCommands</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkBool32</span><span class="w">           </span><span class="n">descriptorBindingAccelerationStructureUpdateAfterBind</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkPhysicalDeviceAccelerationStructureFeaturesKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">accelerationStructure</span> 描述设备是否支持加速结构特性。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">accelerationStructureCaptureReplay</span> 描述设备是否支持保存和重复使用加速结构的设备地址。比如用于追踪捕获和回放。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">accelerationStructureIndirectBuild</span> 描述设备是否支持间接加速结构构建指令。比如 <code class="docutils literal notranslate"><span class="pre">vkCmdBuildAccelerationStructuresIndirectKHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">accelerationStructureHostCommands</span> 描述设备是否支持 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端（ <code class="docutils literal notranslate"><span class="pre">CPU</span></code> ）的加速结构相关指令函数。比如 <code class="docutils literal notranslate"><span class="pre">vkBuildAccelerationStructuresKHR</span></code> ， <code class="docutils literal notranslate"><span class="pre">vkCopyAccelerationStructureKHR</span></code> ， <code class="docutils literal notranslate"><span class="pre">vkCopyAccelerationStructureToMemoryKHR</span></code> ， <code class="docutils literal notranslate"><span class="pre">vkCopyMemoryToAccelerationStructureKHR</span></code> ， <code class="docutils literal notranslate"><span class="pre">vkWriteAccelerationStructuresPropertiesKHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">descriptorBindingAccelerationStructureUpdateAfterBind</span> 描述设备是否支持在描述符集中已经绑定加速结构之后对加速结构进行更新。如果该特性不支持， <code class="docutils literal notranslate"><span class="pre">VK_DESCRIPTOR_BINDING_UPDATE_AFTER_BIND_BIT</span></code> 将不能与 <code class="docutils literal notranslate"><span class="pre">VK_DESCRIPTOR_TYPE_ACCELERATION_STRUCTURE_KHR</span></code> 一起使用。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">host</span></code> 端还是 <code class="docutils literal notranslate"><span class="pre">device</span></code> 端</p>
<p><code class="docutils literal notranslate"><span class="pre">host</span></code> 端一般指 <code class="docutils literal notranslate"><span class="pre">CPU</span></code> 。 <code class="docutils literal notranslate"><span class="pre">device</span></code> 端一般指 <code class="docutils literal notranslate"><span class="pre">GPU</span></code> 。</p>
</div>
<section id="id4">
<h3>例程<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>需要开启 <code class="docutils literal notranslate"><span class="pre">VK_KHR_get_physical_device_properties2</span></code> 扩展</p>
</div>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">VkPhysicalDevice</span><span class="w"> </span><span class="n">vk_physical_device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/*某个精挑细选的物理设备*/</span><span class="p">;</span>

<span class="n">VkPhysicalDeviceAccelerationStructureFeaturesKHR</span><span class="w"> </span><span class="n">vk_physical_device_acceleration_structure_features_khr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="n">vk_physical_device_acceleration_structure_features_khr</span><span class="p">.</span><span class="n">sType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VkStructureType</span><span class="o">::</span><span class="n">VK_STRUCTURE_TYPE_PHYSICAL_DEVICE_ACCELERATION_STRUCTURE_FEATURES_KHR</span><span class="p">;</span>
<span class="n">vk_physical_device_acceleration_structure_features_khr</span><span class="p">.</span><span class="n">pNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="n">vk_physical_device_acceleration_structure_features_khr</span><span class="p">.</span><span class="n">accelerationStructure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VK_FALSE</span><span class="p">;</span>
<span class="n">vk_physical_device_acceleration_structure_features_khr</span><span class="p">.</span><span class="n">accelerationStructureCaptureReplay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VK_FALSE</span><span class="p">;</span>
<span class="n">vk_physical_device_acceleration_structure_features_khr</span><span class="p">.</span><span class="n">accelerationStructureIndirectBuild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VK_FALSE</span><span class="p">;</span>
<span class="n">vk_physical_device_acceleration_structure_features_khr</span><span class="p">.</span><span class="n">accelerationStructureHostCommands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VK_FALSE</span><span class="p">;</span>
<span class="n">vk_physical_device_acceleration_structure_features_khr</span><span class="p">.</span><span class="n">descriptorBindingAccelerationStructureUpdateAfterBind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VK_FALSE</span><span class="p">;</span>

<span class="n">VkPhysicalDeviceFeatures2</span><span class="w"> </span><span class="n">vk_physical_device_features_2</span><span class="p">;</span>
<span class="n">vk_physical_device_features_2</span><span class="p">.</span><span class="n">sType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VkStructureType</span><span class="o">::</span><span class="n">VK_STRUCTURE_TYPE_PHYSICAL_DEVICE_FEATURES_2</span><span class="p">;</span>
<span class="n">vk_physical_device_features_2</span><span class="p">.</span><span class="n">pNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vk_physical_device_acceleration_structure_features_khr</span><span class="p">;</span>
<span class="n">vk_physical_device_features_2</span><span class="p">.</span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="n">vkGetPhysicalDeviceFeatures2KHR</span><span class="p">(</span><span class="n">vk_physical_device</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vk_physical_device_features_2</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="id5">
<h2>激活加速结构特性<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<p>在创建 <code class="docutils literal notranslate"><span class="pre">VkDevice</span></code> 时需要将要开启的特性加入到 <code class="docutils literal notranslate"><span class="pre">VkDeviceCreateInfo::pNext</span></code> 指针链中。</p>
<section id="id6">
<h3>例程<a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">VkPhysicalDevice</span><span class="w"> </span><span class="n">vk_physical_device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/*某个精挑细选的物理设备*/</span><span class="p">;</span>
<span class="n">VkPhysicalDeviceAccelerationStructureFeaturesKHR</span><span class="w"> </span><span class="n">vk_physical_device_acceleration_structure_features_khr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/*之前通过vkGetPhysicalDeviceFeatures2KHR获取到的加速结构特性信息*/</span><span class="p">;</span>

<span class="n">VkDeviceCreateInfo</span><span class="w"> </span><span class="n">vk_device_create_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="n">vk_device_create_info</span><span class="p">.</span><span class="n">sType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VkStructureType</span><span class="o">::</span><span class="n">VK_STRUCTURE_TYPE_DEVICE_CREATE_INFO</span><span class="p">;</span>
<span class="n">vk_device_create_info</span><span class="p">.</span><span class="n">pNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vk_physical_device_acceleration_structure_features_khr</span><span class="p">;</span>
<span class="n">vk_device_create_info</span><span class="p">.</span><span class="w"> </span><span class="p">...</span>

<span class="n">VkDevice</span><span class="w"> </span><span class="n">vk_device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VK_NULL_HANDLE</span><span class="p">;</span>
<span class="n">VkResult</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vkCreateDevice</span><span class="p">(</span><span class="n">vk_physical_device</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vk_device_create_info</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vk_device</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">VK_SUCCESS</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/*创建失败*/</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h2>获取缓存的设备地址<a class="headerlink" href="#id7" title="Link to this heading">#</a></h2>
<section id="vkgetbufferdeviceaddress">
<h3>vkGetBufferDeviceAddress<a class="headerlink" href="#vkgetbufferdeviceaddress" title="Link to this heading">#</a></h3>
<p>为了使得着色器可以访问缓存我们需要获取缓存的设备地址，调用如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_VERSION_1_2 提供</span>
<span class="n">VkDeviceAddress</span><span class="w"> </span><span class="nf">vkGetBufferDeviceAddress</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkBufferDeviceAddressInfo</span><span class="o">*</span><span class="w">            </span><span class="n">pInfo</span><span class="p">);</span>
</pre></div>
</div>
<p>或者与之相等的函数:</p>
</section>
<section id="vkgetbufferdeviceaddresskhr">
<h3>vkGetBufferDeviceAddressKHR<a class="headerlink" href="#vkgetbufferdeviceaddresskhr" title="Link to this heading">#</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_buffer_device_address 提供</span>
<span class="n">VkDeviceAddress</span><span class="w"> </span><span class="nf">vkGetBufferDeviceAddressKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkBufferDeviceAddressInfo</span><span class="o">*</span><span class="w">            </span><span class="n">pInfo</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">device</span> 创建缓存的逻辑设备。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pInfo</span> 指向 <code class="docutils literal notranslate"><span class="pre">VkBufferDeviceAddressInfo</span></code> 结构体指针，内部指定了要获取的目标缓存。</p></li>
</ul>
</section>
<section id="vkbufferdeviceaddressinfo">
<h3>VkBufferDeviceAddressInfo<a class="headerlink" href="#vkbufferdeviceaddressinfo" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkBufferDeviceAddressInfo</span></code> 定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_VERSION_1_2 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkBufferDeviceAddressInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">    </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w">        </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkBuffer</span><span class="w">           </span><span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkBufferDeviceAddressInfo</span><span class="p">;</span>
</pre></div>
</div>
<p>或者与之相等的声明:</p>
</section>
<section id="vkbufferdeviceaddressinfokhr">
<h3>VkBufferDeviceAddressInfoKHR<a class="headerlink" href="#vkbufferdeviceaddressinfokhr" title="Link to this heading">#</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_buffer_device_address 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">VkBufferDeviceAddressInfo</span><span class="w"> </span><span class="n">VkBufferDeviceAddressInfoKHR</span><span class="p">;</span>
</pre></div>
</div>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">buffer</span></code> 必须使用 <code class="docutils literal notranslate"><span class="pre">VK_BUFFER_USAGE_SHADER_DEVICE_ADDRESS_BIT</span></code> 创建。</p></li>
</ul>
</div>
</section>
</section>
<section id="id8">
<h2>加速结构<a class="headerlink" href="#id8" title="Link to this heading">#</a></h2>
<p>加速结构是设备驱动用于光线遍历并管理场景几何体的数据结构。应用的职责是管理加速结构，包括创建、销毁、构建和更新，并在光线查询期间同步资源。</p>
<p>加速结构有两种：</p>
<ul class="simple">
<li><p>顶层加速结构（ <code class="docutils literal notranslate"><span class="pre">top</span> <span class="pre">level</span> <span class="pre">acceleration</span> <span class="pre">structures</span></code> ）</p></li>
<li><p>底层加速结构（ <code class="docutils literal notranslate"><span class="pre">bottom</span> <span class="pre">level</span> <span class="pre">acceleration</span> <span class="pre">structures</span></code> ）</p></li>
</ul>
<p>一个加速结构被构建的标志是对于一个目标加速结构执行了加速结构构建指令或拷贝指令。</p>
<figure class="align-default" id="id36">
<img alt="../../_images/VulkanDocAccelerationStructure.svg" src="../../_images/VulkanDocAccelerationStructure.svg" /><figcaption>
<p><span class="caption-text">加速结构</span><a class="headerlink" href="#id36" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>如图为顶层加速结构和底层加速结构的关系图。</p>
<section id="id9">
<h3>几何体<a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<p>几何体指的是三角形或轴对齐包围盒。</p>
<div class="note admonition">
<p class="admonition-title">轴对齐包围盒</p>
<p>也叫 <code class="docutils literal notranslate"><span class="pre">AABB</span></code> （ <code class="docutils literal notranslate"><span class="pre">Axis</span> <span class="pre">Aligned</span> <span class="pre">Bounding</span> <span class="pre">Box</span></code> ）包围盒。</p>
</div>
</section>
<section id="id10">
<h3>顶层加速结构<a class="headerlink" href="#id10" title="Link to this heading">#</a></h3>
<p>代表实体（ <code class="docutils literal notranslate"><span class="pre">instances</span></code> ）的集合。描述符或设备地址将顶层加速结构作为遍历的起点。</p>
<p>顶层加速结构通过实体可以引用任意的底层加速结构。当顶层加速结构访问底层加速结构时底层加速结构必须保持有效。</p>
</section>
<section id="id11">
<h3>底层加速结构<a class="headerlink" href="#id11" title="Link to this heading">#</a></h3>
<p>用于表示几何体集合</p>
</section>
<section id="id12">
<h3>加速结构的更新规则<a class="headerlink" href="#id12" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Vulkan</span> <span class="pre">API</span></code>  提供两种方式从几何体中生成加速结构：</p>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">构建操作</span> 用于构建一个加速结构</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">更新操作</span> 用于修改一个已经存在的加速结构</p></li>
</ul>
<p>更新操作为了执行的更快更有效率在输入方面施加了一些限制。在进行更新时，应用需要提供对于加速结构完整的描述，除了实体的定义、变换矩阵、顶点和 <code class="docutils literal notranslate"><span class="pre">AABB</span></code> 的位置可以改变，其他的禁止发生改变并与之前的构建描述相匹配。</p>
<p>更明确的说，应用禁止在更新时做如下操作：</p>
<ul class="simple">
<li><p>将图元或实体从有效转成无效，反之亦然。</p></li>
<li><p>更改三角形几何体的索引和顶点格式</p></li>
<li><p>将三角形几何体的变换指针从空变成非空，反之亦然。</p></li>
<li><p>改变加速结构中几何体或实体的数量。</p></li>
<li><p>改变加速结构中几何体的标志位域（ <code class="docutils literal notranslate"><span class="pre">flags</span></code> ）。</p></li>
<li><p>改变加速结构中几何体的顶点数量或图元数量。</p></li>
</ul>
</section>
<section id="id13">
<h3>无效的图元和实体<a class="headerlink" href="#id13" title="Link to this heading">#</a></h3>
<p>加速结构允许使用一个特定的输入值表示无效的图元或实体。</p>
<p>当三角形的每个顶点的第一个（ <code class="docutils literal notranslate"><span class="pre">X</span></code> ）分量为 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> 时即为一个无效三角形。如果顶点的其他分量为 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> 但是第一个分量不为 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> 时其行为是未定义的。如果顶点格式中不存在 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> 的话，则所有的三角形都认为是有效的。</p>
<p>当一个实体引用的加速结构为 <code class="docutils literal notranslate"><span class="pre">0</span></code> 时被认为是无效。</p>
<p>当 <code class="docutils literal notranslate"><span class="pre">AABB</span></code> 的最小 <code class="docutils literal notranslate"><span class="pre">X</span></code> 坐标为 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> 时被认为是无效，如果其他的部分为 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> 而第一个不是 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> 的话其行为是未定义的。</p>
<p>在如上定义中 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> 可以是任意类型的 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> ，比如有符号的。无符号的、安静的、吵闹的或是其他种种。</p>
<div class="note admonition">
<p class="admonition-title">安静的、吵闹的</p>
<p>安静的 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> ，大概率是指 <code class="docutils literal notranslate"><span class="pre">IEEE</span> <span class="pre">754-2008</span></code> 标准中定义的 <code class="docutils literal notranslate"><span class="pre">Quiet</span> <span class="pre">NaN</span></code> 。是指尾数最高位为 <code class="docutils literal notranslate"><span class="pre">1</span></code> 的 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> 值。
吵闹的 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> ，大概率是指 <code class="docutils literal notranslate"><span class="pre">IEEE</span> <span class="pre">754-2008</span></code> 标准中定义的 <code class="docutils literal notranslate"><span class="pre">Signaling</span> <span class="pre">NaN</span></code> 。是指尾数最高位为 <code class="docutils literal notranslate"><span class="pre">0</span></code> ，其余低位不全为 <code class="docutils literal notranslate"><span class="pre">0</span></code> 的 <code class="docutils literal notranslate"><span class="pre">NaN</span></code> 值。</p>
</div>
<p>一个无效对象对于所有的光线都被认为是不可见的，并且不应该出现在加速结构中。驱动应确保无效对象的存在不会严重降低遍历性能。</p>
<p>无效对象使用一个自然增涨的索引值计数，在 <code class="docutils literal notranslate"><span class="pre">SPIR-V</span></code> 是通过 <code class="docutils literal notranslate"><span class="pre">InstanceId</span></code> 和 <code class="docutils literal notranslate"><span class="pre">PrimitiveId</span></code> 体现出来。这允许场景中的对象在有效与无效之间自由的变换。不影响使用 <code class="docutils literal notranslate"><span class="pre">ID</span></code> 值进行索引的任何数组的布局。</p>
<p>对于任何有效与无效状态的转换都需要进行一个完整的加速结构重构建。如果拷贝源加速结构中有效的对象在目标加速结构中变成无效对象，反之亦然，则应用不能执行加速结构的更新。</p>
</section>
</section>
<section id="id14">
<h2>加速结构的描述<a class="headerlink" href="#id14" title="Link to this heading">#</a></h2>
<p>所有的加速结构都通过 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR</span></code> 进行描述：</p>
<section id="vkaccelerationstructurebuildgeometryinfokhr">
<h3>VkAccelerationStructureBuildGeometryInfoKHR<a class="headerlink" href="#vkaccelerationstructurebuildgeometryinfokhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR</span></code> 结构体定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAccelerationStructureBuildGeometryInfoKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">                                     </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w">                                         </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkAccelerationStructureTypeKHR</span><span class="w">                      </span><span class="n">type</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkBuildAccelerationStructureFlagsKHR</span><span class="w">                </span><span class="n">flags</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkBuildAccelerationStructureModeKHR</span><span class="w">                 </span><span class="n">mode</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkAccelerationStructureKHR</span><span class="w">                          </span><span class="n">srcAccelerationStructure</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkAccelerationStructureKHR</span><span class="w">                          </span><span class="n">dstAccelerationStructure</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w">                                            </span><span class="n">geometryCount</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureGeometryKHR</span><span class="o">*</span><span class="w">           </span><span class="n">pGeometries</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureGeometryKHR</span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w">    </span><span class="n">ppGeometries</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkDeviceOrHostAddressKHR</span><span class="w">                            </span><span class="n">scratchData</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureBuildGeometryInfoKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须为 <code class="docutils literal notranslate"><span class="pre">VK_STRUCTURE_TYPE_ACCELERATION_STRUCTURE_BUILD_GEOMETRY_INFO_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向其他结构体来扩展该结构体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">type</span> 用于设置加速结构的构建类型。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">flags</span> 用于指定的加速结构的额外参数。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">mode</span> 用于设置要进行的操作类型。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">srcAccelerationStructure</span> 是用于当 <code class="docutils literal notranslate"><span class="pre">mode</span></code> 为 <code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_MODE_UPDATE_KHR</span></code> 时其指向一个已经存在的加速结构，用于更新到 <code class="docutils literal notranslate"><span class="pre">dst</span></code> 加速结构中 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">dstAccelerationStructure</span> 指向一个用于构建的目标加速结构。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">geometryCount</span> 表示要构建进入到 <code class="docutils literal notranslate"><span class="pre">dstAccelerationStructure</span></code> 的几何数量。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pGeometries</span> 指向数量为 <code class="docutils literal notranslate"><span class="pre">geometryCount</span></code> 类型为 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryKHR</span></code> 结构体数组。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">ppGeometries</span> 指向数量为 <code class="docutils literal notranslate"><span class="pre">geometryCount</span></code> 类型为 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryKHR</span></code> 结构体 <strong>指针</strong> 数组。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">scratchData</span> 是 <code class="docutils literal notranslate"><span class="pre">device</span></code> 或 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端用于构建时暂付缓存的内存地址。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">暂付缓存</p>
<p>暂付缓存（ <code class="docutils literal notranslate"><span class="pre">scratch</span> <span class="pre">buffer</span></code> ），是 <code class="docutils literal notranslate"><span class="pre">Vulkan</span></code> 对于内部缓存的优化。原本的内部缓存应由 <code class="docutils literal notranslate"><span class="pre">Vulkan</span></code> 驱动内部自身分配和管理，但是有些内部内存会经常性的更新，为了优化这一部分缓存， <code class="docutils literal notranslate"><span class="pre">Vulkan</span></code> 将这一部分
缓存交由用户分配管理，优化了内存使用和读写。 <code class="docutils literal notranslate"><span class="pre">scratch</span></code> 原本是抓挠之意，由于这部分内存时不时的要更新一下，像猫抓一样，所以叫 <code class="docutils literal notranslate"><span class="pre">抓挠</span></code> 缓存，实则是暂时交付给 <code class="docutils literal notranslate"><span class="pre">Vulkan</span></code> 驱动内部。</p>
</div>
<p>只有 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 其中之一可以设置有效指针，另外一个必须是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 。有效指针所对应的数组用于描述构建加速结构的几何数据。</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 对应的每一个元素的索引将会作为光线遍历的几何索引。该几何索引可在光追着色器中通过内置的 <code class="docutils literal notranslate"><span class="pre">RayGeometryIndexKHR</span></code> 访问，并且用于在光线遍历时确定运行哪一个最近命中着色器和相交着色器。
该几何索引可以通过 <code class="docutils literal notranslate"><span class="pre">OpRayQueryGetIntersectionGeometryIndexKHR</span></code> 指令进行光线查询。</p>
</div></blockquote>
<p>当 <code class="docutils literal notranslate"><span class="pre">mode</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_MODE_UPDATE_KHR</span></code> 时 <code class="docutils literal notranslate"><span class="pre">srcAccelerationStructure</span></code> 和 <code class="docutils literal notranslate"><span class="pre">dstAccelerationStructure</span></code> 对于此更新操作也许是相同的或是不同的。如果是相同的，其本身将会更新，否则。目标加速结构将会更新而不会修改源加速结构。</p>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>只有 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 其中之一可以设置有效指针，另外一个必须是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">type</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_TOP_LEVEL_KHR</span></code> ，则 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 数组的 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 必须是 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_INSTANCES_KHR</span></code> 。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">type</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_TOP_LEVEL_KHR</span></code> ，则 <code class="docutils literal notranslate"><span class="pre">geometryCount</span></code> 只能是 <code class="docutils literal notranslate"><span class="pre">1</span></code> 。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">type</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_BOTTOM_LEVEL_KHR</span></code> ，则 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 数组的 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 必须不能是 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_INSTANCES_KHR</span></code> 。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">type</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_BOTTOM_LEVEL_KHR</span></code> ，则 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 数组的 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 必须相同 。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">type</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_BOTTOM_LEVEL_KHR</span></code> ，则 <code class="docutils literal notranslate"><span class="pre">geometryCount</span></code> 必须小于等于 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructurePropertiesKHR::maxGeometryCount</span></code> 。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">type</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_BOTTOM_LEVEL_KHR</span></code> ，则 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 数组的 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_AABBS_KHR</span></code> 的话，所有数量的 <code class="docutils literal notranslate"><span class="pre">AABB</span></code> 对应的所有几何体必须小于等于 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructurePropertiesKHR::maxPrimitiveCount</span></code> 。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">type</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_BOTTOM_LEVEL_KHR</span></code> ，则 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 数组的 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_TRIANGLES_KHR</span></code> 的话，所有数量的三角形对应的所有几何体必须小于等于 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructurePropertiesKHR::maxPrimitiveCount</span></code> 。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">flags</span></code> 包含 <code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_PREFER_FAST_TRACE_BIT_KHR</span></code> 位域 ，就不能再包含 <code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_PREFER_FAST_BUILD_BIT_KHR</span></code> 位域了。</p></li>
</ul>
</div>
</section>
<section id="vkbuildaccelerationstructureflagbitskhr">
<h3>VkBuildAccelerationStructureFlagBitsKHR<a class="headerlink" href="#vkbuildaccelerationstructureflagbitskhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR::flags</span></code> 可以设置的值如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">VkBuildAccelerationStructureFlagBitsKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VK_BUILD_ACCELERATION_STRUCTURE_ALLOW_UPDATE_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000001</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_BUILD_ACCELERATION_STRUCTURE_ALLOW_COMPACTION_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000002</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_BUILD_ACCELERATION_STRUCTURE_PREFER_FAST_TRACE_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000004</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_BUILD_ACCELERATION_STRUCTURE_PREFER_FAST_BUILD_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000008</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_BUILD_ACCELERATION_STRUCTURE_LOW_MEMORY_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000010</span><span class="p">,</span><span class="w"> </span><span class="c1">// 由 VK_KHR_ray_tracing_position_fetch 提供</span>
<span class="w">    </span><span class="n">VK_BUILD_ACCELERATION_STRUCTURE_ALLOW_DATA_ACCESS_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000800</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkBuildAccelerationStructureFlagBitsKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_BUILD_ACCELERATION_STRUCTURE_ALLOW_UPDATE_BIT_KHR</span> 表示可以更新 <code class="docutils literal notranslate"><span class="pre">mode</span></code> 为 <code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_MODE_UPDATE_KHR</span></code> 的加速结构。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_BUILD_ACCELERATION_STRUCTURE_ALLOW_COMPACTION_BIT_KHR</span> 表示可以作为 <code class="docutils literal notranslate"><span class="pre">mode</span></code> 为 <code class="docutils literal notranslate"><span class="pre">VK_COPY_ACCELERATION_STRUCTURE_MODE_COMPACT_KHR</span></code> 加速结构拷贝指令的数据源进行压缩。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_BUILD_ACCELERATION_STRUCTURE_PREFER_FAST_TRACE_BIT_KHR</span> 表示在构建加速结构时优先考虑优化光追性能。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_BUILD_ACCELERATION_STRUCTURE_PREFER_FAST_BUILD_BIT_KHR</span> 表示在构建加速结构时优先考虑优化构建时长。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_BUILD_ACCELERATION_STRUCTURE_LOW_MEMORY_BIT_KHR</span> 表示最小化加速结构的暂付缓存，这背后可能会增加构建时长和光追性能。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_BUILD_ACCELERATION_STRUCTURE_ALLOW_DATA_ACCESS_KHR</span> 表示当光线击中三角形获取顶点位置时可以使用该加速结构。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_ALLOW_UPDATE_BIT_KHR</span></code> 和 <code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_ALLOW_COMPACTION_BIT_KHR</span></code> 的设置可能会比正常创建花费更多的时间，并且应该在有相应需求时使用这两个特性。</p>
</div>
</section>
<section id="vkbuildaccelerationstructuremodekhr">
<h3>VkBuildAccelerationStructureModeKHR<a class="headerlink" href="#vkbuildaccelerationstructuremodekhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkBuildAccelerationStructureModeKHR</span></code> 枚举定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">VkBuildAccelerationStructureModeKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VK_BUILD_ACCELERATION_STRUCTURE_MODE_BUILD_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_BUILD_ACCELERATION_STRUCTURE_MODE_UPDATE_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkBuildAccelerationStructureModeKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_BUILD_ACCELERATION_STRUCTURE_MODE_BUILD_KHR</span> 表示目标加速结构将会使用用户提供的几何数据构建。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_BUILD_ACCELERATION_STRUCTURE_MODE_UPDATE_KHR</span> 表示目标加速结构将会使用用户提供的源加速结构的几何数据进行更新。</p></li>
</ul>
</section>
<section id="vkdeviceorhostaddresskhr">
<h3>VkDeviceOrHostAddressKHR<a class="headerlink" href="#vkdeviceorhostaddresskhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkDeviceOrHostAddressKHR</span></code> 定义的 <code class="docutils literal notranslate"><span class="pre">union</span></code> 联合体如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">VkDeviceOrHostAddressKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkDeviceAddress</span><span class="w">    </span><span class="n">deviceAddress</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w">              </span><span class="n">hostAddress</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkDeviceOrHostAddressKHR</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">VkDeviceOrHostAddressKHR</span></code> 是联合体 <code class="docutils literal notranslate"><span class="pre">union</span></code> 。</p>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">deviceAddress</span> 表示通过 <code class="docutils literal notranslate"><span class="pre">vkGetBufferDeviceAddressKHR</span></code> 获取到的设备缓存地址。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">hostAddress</span> 表示 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端的内存地址。</p></li>
</ul>
</section>
<section id="vkdeviceorhostaddressconstkhr">
<h3>VkDeviceOrHostAddressConstKHR<a class="headerlink" href="#vkdeviceorhostaddressconstkhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkDeviceOrHostAddressConstKHR</span></code> 定义的 <code class="docutils literal notranslate"><span class="pre">union</span></code> 联合体如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">VkDeviceOrHostAddressConstKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkDeviceAddress</span><span class="w">    </span><span class="n">deviceAddress</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w">        </span><span class="n">hostAddress</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkDeviceOrHostAddressConstKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">deviceAddress</span> 表示通过 <code class="docutils literal notranslate"><span class="pre">vkGetBufferDeviceAddressKHR</span></code> 获取到的设备缓存地址。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">hostAddress</span> 表示 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端的内存地址。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">VkDeviceOrHostAddressConstKHR</span></code> 是联合体 <code class="docutils literal notranslate"><span class="pre">union</span></code> 。比 <code class="docutils literal notranslate"><span class="pre">VkDeviceOrHostAddressKHR</span></code> 在命名上多了个 <code class="docutils literal notranslate"><span class="pre">Const</span></code> 。</p>
</div>
</section>
<section id="vkaccelerationstructuregeometrykhr">
<h3>VkAccelerationStructureGeometryKHR<a class="headerlink" href="#vkaccelerationstructuregeometrykhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryKHR</span></code> 结构体定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAccelerationStructureGeometryKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">                           </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w">                               </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkGeometryTypeKHR</span><span class="w">                         </span><span class="n">geometryType</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkAccelerationStructureGeometryDataKHR</span><span class="w">    </span><span class="n">geometry</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkGeometryFlagsKHR</span><span class="w">                        </span><span class="n">flags</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureGeometryKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须为 <code class="docutils literal notranslate"><span class="pre">VK_STRUCTURE_TYPE_ACCELERATION_STRUCTURE_GEOMETRY_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向其他结构体来扩展该结构体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">geometryType</span> 描述几何类型。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">geometry</span> 为 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryDataKHR</span></code> 联合类型，描述 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 对应的数据。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">flags</span> 是 <code class="docutils literal notranslate"><span class="pre">VkGeometryFlagBitsKHR</span></code> 值的位域，用于描述几何体如何构建的额外参数。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>目前 <code class="docutils literal notranslate"><span class="pre">pNext</span></code> 必须为 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 为 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_TRIANGLES_KHR</span></code> 的话， <code class="docutils literal notranslate"><span class="pre">geometry</span></code> 的 <code class="docutils literal notranslate"><span class="pre">triangles</span></code> 成员必须是一个有效的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR</span></code> 结构数据。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 为 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_AABBS_KHR</span></code> 的话， <code class="docutils literal notranslate"><span class="pre">geometry</span></code> 的 <code class="docutils literal notranslate"><span class="pre">aabbs</span></code> 成员必须是一个有效的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryAabbsDataKHR</span></code> 结构数据。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 为 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_INSTANCES_KHR</span></code> 的话， <code class="docutils literal notranslate"><span class="pre">geometry</span></code> 的 <code class="docutils literal notranslate"><span class="pre">instances</span></code> 成员必须是一个有效的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryInstancesDataKHR</span></code> 结构数据。</p></li>
</ul>
</div>
</section>
<section id="vkgeometrytypekhr">
<h3>VkGeometryTypeKHR<a class="headerlink" href="#vkgeometrytypekhr" title="Link to this heading">#</a></h3>
<p>几何类型通过 <code class="docutils literal notranslate"><span class="pre">VkGeometryTypeKHR</span></code> 指定，其定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">VkGeometryTypeKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VK_GEOMETRY_TYPE_TRIANGLES_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_GEOMETRY_TYPE_AABBS_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_GEOMETRY_TYPE_INSTANCES_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkGeometryTypeKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_GEOMETRY_TYPE_TRIANGLES_KHR</span> 表示几何类型由三角形组成。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_GEOMETRY_TYPE_AABBS_KHR</span> 表示几何类型由轴对齐包围盒组成。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_GEOMETRY_TYPE_INSTANCES_KHR</span> 表示几何类型由加速结构实体组成。</p></li>
</ul>
</section>
<section id="vkgeometryflagbitskhr">
<h3>VkGeometryFlagBitsKHR<a class="headerlink" href="#vkgeometryflagbitskhr" title="Link to this heading">#</a></h3>
<p>几何体在加速结构构架中额外参数：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">VkGeometryFlagBitsKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VK_GEOMETRY_OPAQUE_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000001</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_GEOMETRY_NO_DUPLICATE_ANY_HIT_INVOCATION_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000002</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkGeometryFlagBitsKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_GEOMETRY_OPAQUE_BIT_KHR</span> 表示就算追踪时产生了一个击中组该几何体也不会去调用任意命中着色器。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_GEOMETRY_NO_DUPLICATE_ANY_HIT_INVOCATION_BIT_KHR</span> 表示驱动对于几何体上的每一个图元只会调用一次任意命中着色器。如果该标志位域没有设置，驱动可能会对该结合体调用多次任意命中着色器。</p></li>
</ul>
</section>
<section id="vkaccelerationstructuregeometrydatakhr">
<h3>VkAccelerationStructureGeometryDataKHR<a class="headerlink" href="#vkaccelerationstructuregeometrydatakhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryDataKHR</span></code> 定义的 <code class="docutils literal notranslate"><span class="pre">union</span></code> 联合体如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">VkAccelerationStructureGeometryDataKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">VkAccelerationStructureGeometryTrianglesDataKHR</span><span class="w"> </span><span class="n">triangles</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkAccelerationStructureGeometryAabbsDataKHR</span><span class="w"> </span><span class="n">aabbs</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkAccelerationStructureGeometryInstancesDataKHR</span><span class="w"> </span><span class="n">instances</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureGeometryDataKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">triangles</span> 是 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR</span></code> 结构数据。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">aabbs</span> 是 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryAabbsDataKHR</span></code> 结构数据。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">instances</span> 是 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryInstancesDataKHR</span></code> 结构数据。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryDataKHR</span></code> 是联合体 <code class="docutils literal notranslate"><span class="pre">union</span></code> 。</p>
</div>
</section>
<section id="vkaccelerationstructuregeometrytrianglesdatakhr">
<h3>VkAccelerationStructureGeometryTrianglesDataKHR<a class="headerlink" href="#vkaccelerationstructuregeometrytrianglesdatakhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR</span></code> 结构体定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAccelerationStructureGeometryTrianglesDataKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">VkStructureType</span><span class="w"> </span><span class="n">sType</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkFormat</span><span class="w"> </span><span class="n">vertexFormat</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkDeviceOrHostAddressConstKHR</span><span class="w"> </span><span class="n">vertexData</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkDeviceSize</span><span class="w"> </span><span class="n">vertexStride</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">maxVertex</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkIndexType</span><span class="w"> </span><span class="n">indexType</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkDeviceOrHostAddressConstKHR</span><span class="w"> </span><span class="n">indexData</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkDeviceOrHostAddressConstKHR</span><span class="w"> </span><span class="n">transformData</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureGeometryTrianglesDataKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须为 <code class="docutils literal notranslate"><span class="pre">VK_STRUCTURE_TYPE_ACCELERATION_STRUCTURE_GEOMETRY_TRIANGLES_DATA_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向其他结构体来扩展该结构体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">vertexFormat</span> 是顶点数据的格式。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">vertexData</span> 是 <code class="docutils literal notranslate"><span class="pre">device</span></code> 或 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端包含几何顶点数据的内存地址。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">maxVertex</span> 是在使用该结构体构建加速结构时可以寻址的最高顶点数据索引。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">vertexStride</span> 点与点之间的比特跨度。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">indexType</span> 是索引的 <code class="docutils literal notranslate"><span class="pre">VkIndexType</span></code> 类型。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">indexData</span> 是包含索引数据的 <code class="docutils literal notranslate"><span class="pre">device</span></code> 或 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端内存地址。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">transformData</span> 是包含一个用于描述该加速结构中几何体变换数据 <code class="docutils literal notranslate"><span class="pre">VkTransformMatrixKHR</span></code> 的 <code class="docutils literal notranslate"><span class="pre">device</span></code> 或 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端内存地址。该数据的设置是可选的。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>与图形管线 <code class="docutils literal notranslate"><span class="pre">VkVertexInputBindingDescription</span></code> 的顶端缓存跨度最大不能超过 <code class="docutils literal notranslate"><span class="pre">maxVertexInputBindingStride</span></code> 不同，加速结构几何体的 <code class="docutils literal notranslate"><span class="pre">vertexStride</span></code> 被限制在32位值中。</p>
</div>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vertexStride</span></code> 必须为 <code class="docutils literal notranslate"><span class="pre">vertexFormat</span></code> 最小分量比特的倍数 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vertexStride</span></code> 必须小于等于 <span class="math notranslate nohighlight">\(2^{32}-1\)</span> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vertexFormat</span></code> 的格式特性必须包括 <code class="docutils literal notranslate"><span class="pre">VK_FORMAT_FEATURE_ACCELERATION_STRUCTURE_VERTEX_BUFFER_BIT_KHR</span></code> 特性。</p></li>
</ul>
</div>
</section>
<section id="vktransformmatrixkhr">
<h3>VkTransformMatrixKHR<a class="headerlink" href="#vktransformmatrixkhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkTransformMatrixKHR</span></code> 结构体定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkTransformMatrixKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkTransformMatrixKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">matrix</span> 是 <span class="math notranslate nohighlight">\(3\times4\)</span> 行主式仿射变换矩阵 。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">matrix</span></code> 内部的 <span class="math notranslate nohighlight">\(3\times3\)</span> 矩阵必须是可逆矩阵。</p></li>
</ul>
</div>
</section>
<section id="vkaccelerationstructuregeometryaabbsdatakhr">
<h3>VkAccelerationStructureGeometryAabbsDataKHR<a class="headerlink" href="#vkaccelerationstructuregeometryaabbsdatakhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryAabbsDataKHR</span></code> 结构体定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAccelerationStructureGeometryAabbsDataKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">VkStructureType</span><span class="w"> </span><span class="n">sType</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkDeviceOrHostAddressConstKHR</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkDeviceSize</span><span class="w"> </span><span class="n">stride</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureGeometryAabbsDataKHR</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须为 <code class="docutils literal notranslate"><span class="pre">VK_STRUCTURE_TYPE_ACCELERATION_STRUCTURE_GEOMETRY_AABBS_DATA_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向其他结构体来扩展该结构体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">data</span> 是 <code class="docutils literal notranslate"><span class="pre">device</span></code> 或 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端包含位置数据的 <code class="docutils literal notranslate"><span class="pre">VkAabbPositionsKHR</span></code> 轴对齐包围盒数据内存地址。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">stride</span> <code class="docutils literal notranslate"><span class="pre">data</span></code> 条目之间的比特跨度。并且必须是 <code class="docutils literal notranslate"><span class="pre">8</span></code> 的倍数。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">stride</span></code> 必须小于等于 <span class="math notranslate nohighlight">\(2^{32}-1\)</span> 。</p></li>
</ul>
</div></blockquote>
</div>
</section>
<section id="vkaabbpositionskhr">
<h3>VkAabbPositionsKHR<a class="headerlink" href="#vkaabbpositionskhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAabbPositionsKHR</span></code> 结构体定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAabbPositionsKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">minX</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">minY</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">minZ</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">maxX</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">maxY</span><span class="p">;</span>
<span class="w">  </span><span class="kt">float</span><span class="w"> </span><span class="n">maxZ</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAabbPositionsKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">minX</span> 包围盒边界框对角的 <code class="docutils literal notranslate"><span class="pre">x</span></code> 位置。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">minY</span> 包围盒边界框对角的 <code class="docutils literal notranslate"><span class="pre">y</span></code> 位置。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">minZ</span> 包围盒边界框对角的 <code class="docutils literal notranslate"><span class="pre">z</span></code> 位置。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">maxX</span> 包围盒边界框另一对角的 <code class="docutils literal notranslate"><span class="pre">x</span></code> 位置。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">maxY</span> 包围盒边界框另一对角的 <code class="docutils literal notranslate"><span class="pre">y</span></code> 位置。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">maxZ</span> 包围盒边界框另一对角的 <code class="docutils literal notranslate"><span class="pre">z</span></code> 位置。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">minX</span></code> 必须小于等于 <code class="docutils literal notranslate"><span class="pre">maxX</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minY</span></code> 必须小于等于 <code class="docutils literal notranslate"><span class="pre">maxY</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minZ</span></code> 必须小于等于 <code class="docutils literal notranslate"><span class="pre">maxZ</span></code> 。</p></li>
</ul>
</div></blockquote>
</div>
</section>
<section id="vkaccelerationstructuregeometryinstancesdatakhr">
<h3>VkAccelerationStructureGeometryInstancesDataKHR<a class="headerlink" href="#vkaccelerationstructuregeometryinstancesdatakhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryInstancesDataKHR</span></code> 结构体定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAccelerationStructureGeometryInstancesDataKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">VkStructureType</span><span class="w"> </span><span class="n">sType</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkBool32</span><span class="w"> </span><span class="n">arrayOfPointers</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkDeviceOrHostAddressConstKHR</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureGeometryInstancesDataKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须为 <code class="docutils literal notranslate"><span class="pre">VK_STRUCTURE_TYPE_ACCELERATION_STRUCTURE_GEOMETRY_INSTANCES_DATA_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向其他结构体来扩展该结构体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">arrayOfPointers</span> 用于指示 <code class="docutils literal notranslate"><span class="pre">data</span></code> 是按照地址数组解析还是就是一个数组解析。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">data</span> 如果 <code class="docutils literal notranslate"><span class="pre">arrayOfPointers</span></code> 为 <code class="docutils literal notranslate"><span class="pre">VK_TRUE</span></code> ，该 <code class="docutils literal notranslate"><span class="pre">data</span></code> 用于单独的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureInstanceKHR</span></code> 引用 <code class="docutils literal notranslate"><span class="pre">device</span></code> 或 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端数组，如果为 <code class="docutils literal notranslate"><span class="pre">VK_FALSE</span></code> 的话将会是 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureInstanceKHR</span></code> 数组地址，并且 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureInstanceKHR</span></code> 是紧密排布的。</p></li>
</ul>
<p>加速结构实体 （ <code class="docutils literal notranslate"><span class="pre">instances</span></code> ）可以构建进顶层加速结构中。每一个加速结构实体在包含所有底层加速结构的顶层加速结构中都是一个单独项。多个实体可以指向相同的底层加速结构。</p>
<div class="note admonition">
<p class="admonition-title">加速结构实体</p>
<p>指的是 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureInstanceKHR</span></code> 。一般在 <code class="docutils literal notranslate"><span class="pre">Vulkan</span></code> 光追标准中也叫 <code class="docutils literal notranslate"><span class="pre">实体</span></code> （ <code class="docutils literal notranslate"><span class="pre">instances</span></code> ）。</p>
</div>
</section>
<section id="vkaccelerationstructureinstancekhr">
<h3>VkAccelerationStructureInstanceKHR<a class="headerlink" href="#vkaccelerationstructureinstancekhr" title="Link to this heading">#</a></h3>
<p>一个加速结构实体通过 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureInstanceKHR</span></code> 定义：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAccelerationStructureInstanceKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">VkTransformMatrixKHR</span><span class="w"> </span><span class="n">transform</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">instanceCustomIndex</span><span class="o">:</span><span class="mi">24</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">mask</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">instanceShaderBindingTableRecordOffset</span><span class="o">:</span><span class="mi">24</span><span class="p">;</span>
<span class="w">  </span><span class="n">VkGeometryInstanceFlagsKHR</span><span class="w"> </span><span class="n">flags</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">accelerationStructureReference</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureInstanceKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">transform</span> 用于描述该实体的变换。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">instanceCustomIndex</span> 用户自定义的 <code class="docutils literal notranslate"><span class="pre">24</span></code> 比特索引值。该值可通过光追着色器的内置变量 <code class="docutils literal notranslate"><span class="pre">InstanceCustomIndexKHR</span></code> 进行访问。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">mask</span> 是一个 <code class="docutils literal notranslate"><span class="pre">8</span></code> 比特可见性遮罩值。只有当 <code class="docutils literal notranslate"><span class="pre">Cull</span> <span class="pre">Mask</span> <span class="pre">&amp;</span> <span class="pre">instance.mask</span> <span class="pre">!=</span> <span class="pre">0</span></code> 时实体才会被光线击中。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">instanceShaderBindingTableRecordOffset</span> 是一个 <code class="docutils literal notranslate"><span class="pre">24</span></code> 比特偏移值。用于计算命中着色器绑定表索引。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">flags</span> 是一个 <code class="docutils literal notranslate"><span class="pre">8</span></code> 比特 <code class="docutils literal notranslate"><span class="pre">VkGeometryInstanceFlagBitsKHR</span></code> 遮罩值引用在该实体上。</p></li>
<li><dl class="simple">
<dt><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">accelerationStructureReference</span> 是一下两者之一。</dt><dd><ul>
<li><p>从 <code class="docutils literal notranslate"><span class="pre">vkGetAccelerationStructureDeviceAddressKHR</span></code> 获取到包含数据的 <code class="docutils literal notranslate"><span class="pre">device</span></code> 地址。将会被用于加速结构 <code class="docutils literal notranslate"><span class="pre">device</span></code> 操作中。</p></li>
<li><p>一个 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureKHR</span></code> 对象。将会被用于设备加速结构 <code class="docutils literal notranslate"><span class="pre">host</span></code> 操作中。</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">C</span></code> 语言标准的规范并没有定义位域的顺序，但是一般，对于现有编译器都会提供正确的结构体布局。这默认的位域模板如下：</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">instanceCustomIndex</span></code> 和 <code class="docutils literal notranslate"><span class="pre">mask</span></code> 将会一同占用一个 <code class="docutils literal notranslate"><span class="pre">uint32_t</span></code> 。</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">instanceCustomIndex</span></code> 占用开头的 <code class="docutils literal notranslate"><span class="pre">24</span></code> 位</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mask</span></code> 占用之后的 <code class="docutils literal notranslate"><span class="pre">8</span></code> 位</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">instanceShaderBindingTableRecordOffset</span></code> 和 <code class="docutils literal notranslate"><span class="pre">flags</span></code> 将会一同占用一个 <code class="docutils literal notranslate"><span class="pre">uint32_t</span></code> 。</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">instanceCustomIndex</span></code> 占用开头的 <code class="docutils literal notranslate"><span class="pre">24</span></code> 位</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mask</span></code> 占用之后的 <code class="docutils literal notranslate"><span class="pre">8</span></code> 位</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>如果编译器没有按照此方式进行结构体内存布局，应用需要根据如上模板使用其他方式设置数值。</p>
</section>
<section id="vkgeometryinstanceflagbitskhr">
<h3>VkGeometryInstanceFlagBitsKHR<a class="headerlink" href="#vkgeometryinstanceflagbitskhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureInstanceKHR::flags</span></code> 用于设置实体的行为位域值如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">VkGeometryInstanceFlagBitsKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">VK_GEOMETRY_INSTANCE_TRIANGLE_FACING_CULL_DISABLE_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000001</span><span class="p">,</span>
<span class="w">  </span><span class="n">VK_GEOMETRY_INSTANCE_TRIANGLE_FLIP_FACING_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000002</span><span class="p">,</span>
<span class="w">  </span><span class="n">VK_GEOMETRY_INSTANCE_FORCE_OPAQUE_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000004</span><span class="p">,</span>
<span class="w">  </span><span class="n">VK_GEOMETRY_INSTANCE_FORCE_NO_OPAQUE_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000008</span><span class="p">,</span>
<span class="w">  </span><span class="n">VK_GEOMETRY_INSTANCE_TRIANGLE_FRONT_COUNTERCLOCKWISE_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VK_GEOMETRY_INSTANCE_TRIANGLE_FLIP_FACING_BIT_KHR</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkGeometryInstanceFlagBitsKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_GEOMETRY_INSTANCE_TRIANGLE_FACING_CULL_DISABLE_BIT_KHR</span> 取消实体的面剔除。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_GEOMETRY_INSTANCE_TRIANGLE_FLIP_FACING_BIT_KHR</span> 表示确认哪一个是正面，与之前的判断策略相反。由于是使用物体空间（ <code class="docutils literal notranslate"><span class="pre">object</span> <span class="pre">space</span></code> ）来判断正反面，在实体上的变换并不会影响判断结构，但是对于几何体的变换会影响判断结果。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_GEOMETRY_INSTANCE_FORCE_OPAQUE_BIT_KHR</span> 表示该实体下的所有几何体都被认为是 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_OPAQUE_BIT_KHR</span></code> ，该行为可通过 <code class="docutils literal notranslate"><span class="pre">SPIR-V</span></code> 的 <code class="docutils literal notranslate"><span class="pre">NoOpaqueKHR</span></code> 光追标志位进行覆盖。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_GEOMETRY_INSTANCE_FORCE_NO_OPAQUE_BIT_KHR</span> 表示该实体下的所有几何体都不被认为是 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_OPAQUE_BIT_KHR</span></code> ，该行为可通过 <code class="docutils literal notranslate"><span class="pre">SPIR-V</span></code> 的 <code class="docutils literal notranslate"><span class="pre">NoOpaqueKHR</span></code> 光追标志位进行覆盖。</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_INSTANCE_FORCE_NO_OPAQUE_BIT_KHR</span></code> 和 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_INSTANCE_FORCE_OPAQUE_BIT_KHR</span></code> 这两个标志位域一定不能同时使用。</p>
</section>
</section>
<section id="id15">
<h2>获取加速结构的构建大小<a class="headerlink" href="#id15" title="Link to this heading">#</a></h2>
<section id="id16">
<h3>vkGetAccelerationStructureBuildSizesKHR<a class="headerlink" href="#id16" title="Link to this heading">#</a></h3>
<p>为了获取加速结构构建的大小，调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vkGetAccelerationStructureBuildSizesKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkAccelerationStructureBuildTypeKHR</span><span class="w">         </span><span class="n">buildType</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureBuildGeometryInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="n">pBuildInfo</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">uint32_t</span><span class="o">*</span><span class="w">                             </span><span class="n">pMaxPrimitiveCounts</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkAccelerationStructureBuildSizesInfoKHR</span><span class="o">*</span><span class="w">   </span><span class="n">pSizeInfo</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">device</span> 用于创建加速结构的逻辑设备句柄。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">buildType</span> 指定是使用 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端还是 <code class="docutils literal notranslate"><span class="pre">device</span></code> 端（或是两者兼得）上构建加速结构。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pBuildInfo</span> 描述构建的参数。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pMaxPrimitiveCounts</span> 是指向类型为 <code class="docutils literal notranslate"><span class="pre">uint32_t</span></code> 长度为 <code class="docutils literal notranslate"><span class="pre">pBuildInfo-&gt;geometryCount</span></code> 的数组指针。用于定义有多少图元构建进入每个几何体中。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pSizeInfo</span> 返回构建加速结构时需要的大小、暂付缓存的大小。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">获取加速结构的构建大小</p>
<p>在获取加速结构要构建的大小时，主要是通过 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR</span></code> 描述加速结构，而不像 <code class="docutils literal notranslate"><span class="pre">VkImage</span></code> 和 <code class="docutils literal notranslate"><span class="pre">VkBuffer</span></code> 这类先创建资源句柄再获取资源要分配的大小。换而言之，加速结构在获取大小时不需要先创建完加速结构资源句柄后再获取大小。</p>
</div>
<p>在调用该函数时 <code class="docutils literal notranslate"><span class="pre">pBuildInfo</span></code> 的 <code class="docutils literal notranslate"><span class="pre">srcAccelerationStructure</span></code> 、 <code class="docutils literal notranslate"><span class="pre">dstAccelerationStructure</span></code> 和 <code class="docutils literal notranslate"><span class="pre">mode</span></code> 成员数据会被忽略。 <code class="docutils literal notranslate"><span class="pre">pBuildInfo</span></code> 中 <code class="docutils literal notranslate"><span class="pre">VkDeviceOrHostAddressKHR</span> <span class="pre">scratchData</span></code> 也将会被忽略，除非 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::transformData</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">hostAddress</span></code> 成员是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 。</p>
<p>使用该函数中的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildSizesInfoKHR</span></code> 返回的 <code class="docutils literal notranslate"><span class="pre">accelerationStructureSize</span></code> 的大小创建加速结构，为了支持使用 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR</span></code> 和 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildRangeInfoKHR</span></code> 数组进行任意的构建和更新，构建和更新时需要依照如下规范：</p>
<ul class="simple">
<li><p>构建指令是 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端， <code class="docutils literal notranslate"><span class="pre">buildType</span></code> 需要是 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_BUILD_TYPE_HOST_KHR</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_BUILD_TYPE_HOST_OR_DEVICE_KHR</span></code> 。</p></li>
<li><p>构建指令是 <code class="docutils literal notranslate"><span class="pre">device</span></code> 端， <code class="docutils literal notranslate"><span class="pre">buildType</span></code> 需要是 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_BUILD_TYPE_DEVICE_KHR</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_BUILD_TYPE_HOST_OR_DEVICE_KHR</span></code> 。</p></li>
<li><dl class="simple">
<dt>对于 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR</span></code> ：</dt><dd><ul>
<li><p>其 <code class="docutils literal notranslate"><span class="pre">type</span></code> 和 <code class="docutils literal notranslate"><span class="pre">flags</span></code> 成员需要分别与 <code class="docutils literal notranslate"><span class="pre">pBuildInfo-&gt;type</span></code> 和 <code class="docutils literal notranslate"><span class="pre">pBuildInfo-&gt;flags</span></code> 对应相等。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">geometryCount</span></code> 需要小于等与 <code class="docutils literal notranslate"><span class="pre">pBuildInfo-&gt;geometryCount</span></code> 。</p></li>
<li><p>对于 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 数组中的每一个元素，其 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 成员需要与 <code class="docutils literal notranslate"><span class="pre">pBuildInfo-&gt;geometryType</span></code> 相等。</p></li>
<li><p>对于 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 数组中的每一个元素，其 <code class="docutils literal notranslate"><span class="pre">flags</span></code> 成员需要与 <code class="docutils literal notranslate"><span class="pre">pBuildInfo-&gt;flags</span></code> 相等。</p></li>
<li><p>对于 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 数组中的每一个元素，当其 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 成员等于 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_TRIANGLES_KHR</span></code> 时， <code class="docutils literal notranslate"><span class="pre">geometry.triangles</span></code> 的 <code class="docutils literal notranslate"><span class="pre">vertexFormat</span></code> 和 <code class="docutils literal notranslate"><span class="pre">indexType</span></code> 成员需要与 <code class="docutils literal notranslate"><span class="pre">pBuildInfo</span></code> 中的对应成员相等。</p></li>
<li><p>对于 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 数组中的每一个元素，当其 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 成员等于 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_TRIANGLES_KHR</span></code> 时， <code class="docutils literal notranslate"><span class="pre">geometry.triangles</span></code> 的 <code class="docutils literal notranslate"><span class="pre">maxVertex</span></code> 成员需要与 <code class="docutils literal notranslate"><span class="pre">pBuildInfo</span></code> 中的对应成员相等。</p></li>
<li><p>对于 <code class="docutils literal notranslate"><span class="pre">pGeometries</span></code> 或 <code class="docutils literal notranslate"><span class="pre">ppGeometries</span></code> 数组中的每一个元素，当其 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 成员等于 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_TRIANGLES_KHR</span></code> 时， <code class="docutils literal notranslate"><span class="pre">geometry.triangles</span></code> 的 <code class="docutils literal notranslate"><span class="pre">transformData</span></code> 成员不是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> ， <code class="docutils literal notranslate"><span class="pre">pBuildInfo</span></code> 对应的 <code class="docutils literal notranslate"><span class="pre">transformData.hostAddress</span></code> 也不能是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 。</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>对于每一个与 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR</span></code> 对应的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildRangeInfoKHR</span></code> ：</dt><dd><ul>
<li><p>其 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR</span></code> 的 <code class="docutils literal notranslate"><span class="pre">primitiveCount</span></code> 成员需要小于等于对应 <code class="docutils literal notranslate"><span class="pre">pMaxPrimitiveCounts</span></code> 的元素。</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>与之相似的 <code class="docutils literal notranslate"><span class="pre">updateScratchSize</span></code> 在如上规范下使用 <code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_MODE_UPDATE_KHR</span></code> 的 <code class="docutils literal notranslate"><span class="pre">mode</span></code> 的话将支持任意构建指令，并且 <code class="docutils literal notranslate"><span class="pre">buildScratchSize</span></code> 值在如上规范下使用 <code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_MODE_BUILD_KHR</span></code> 的 <code class="docutils literal notranslate"><span class="pre">mode</span></code> 的话将支持任意构建指令。</p>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>必须激活 <code class="docutils literal notranslate"><span class="pre">rayTracingPipeline</span></code> 或 <code class="docutils literal notranslate"><span class="pre">rayQuery</span></code> 特性。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">device</span></code> 使用多物理设备创建的，则一定不能激活 <code class="docutils literal notranslate"><span class="pre">bufferDeviceAddressMultiDevice</span></code> 特性。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">pBuildInfo-&gt;geometryCount</span></code> 不是 <code class="docutils literal notranslate"><span class="pre">0</span></code> 的话， <code class="docutils literal notranslate"><span class="pre">pMaxPrimitiveCounts</span></code> 必须指向一个有效的类型为 <code class="docutils literal notranslate"><span class="pre">uint32_t</span></code> 长度为 <code class="docutils literal notranslate"><span class="pre">pBuildInfo-&gt;geometryCount</span></code> 的数组指针。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">pBuildInfo-&gt;pGeometries</span></code> 或 <code class="docutils literal notranslate"><span class="pre">pBuildInfo-&gt;ppGeometries</span></code> 有一个 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_INSTANCES_KHR</span></code> 类型的 <code class="docutils literal notranslate"><span class="pre">geometryType</span></code> 的话，每一个 <code class="docutils literal notranslate"><span class="pre">pMaxPrimitiveCounts[i]</span></code> 必须小于等于 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructurePropertiesKHR::maxInstanceCount</span></code> 。</p></li>
</ul>
</div>
</section>
<section id="vkaccelerationstructurebuildtypekhr">
<h3>VkAccelerationStructureBuildTypeKHR<a class="headerlink" href="#vkaccelerationstructurebuildtypekhr" title="Link to this heading">#</a></h3>
<p>对于 <code class="docutils literal notranslate"><span class="pre">vkGetAccelerationStructureBuildSizesKHR</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">buildType</span></code> 可设值为：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">VkAccelerationStructureBuildTypeKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VK_ACCELERATION_STRUCTURE_BUILD_TYPE_HOST_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_ACCELERATION_STRUCTURE_BUILD_TYPE_DEVICE_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_ACCELERATION_STRUCTURE_BUILD_TYPE_HOST_OR_DEVICE_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureBuildTypeKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_ACCELERATION_STRUCTURE_BUILD_TYPE_HOST_KHR</span> 请求的内存将会使用 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端进行操作。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_ACCELERATION_STRUCTURE_BUILD_TYPE_DEVICE_KHR</span> 请求的内存将会使用 <code class="docutils literal notranslate"><span class="pre">device</span></code> 端进行操作。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_ACCELERATION_STRUCTURE_BUILD_TYPE_HOST_OR_DEVICE_KHR</span> 请求的内存将会同时支持使用  <code class="docutils literal notranslate"><span class="pre">host</span></code> 端和 <code class="docutils literal notranslate"><span class="pre">device</span></code> 端进行操作。</p></li>
</ul>
</section>
<section id="vkaccelerationstructurebuildsizesinfokhr">
<h3>VkAccelerationStructureBuildSizesInfoKHR<a class="headerlink" href="#vkaccelerationstructurebuildsizesinfokhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildSizesInfoKHR</span></code> 结构体描述了加速结构构建需求大小和暂付缓存的大小：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAccelerationStructureBuildSizesInfoKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">    </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w">        </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkDeviceSize</span><span class="w">       </span><span class="n">accelerationStructureSize</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkDeviceSize</span><span class="w">       </span><span class="n">updateScratchSize</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkDeviceSize</span><span class="w">       </span><span class="n">buildScratchSize</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureBuildSizesInfoKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须为 <code class="docutils literal notranslate"><span class="pre">VK_STRUCTURE_TYPE_ACCELERATION_STRUCTURE_BUILD_SIZES_INFO_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向其他结构体来扩展该结构体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">accelerationStructureSize</span> 为 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureKHR</span></code> 在构建和更新时需要的比特大小。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">updateScratchSize</span> 在更新时需要暂付缓存的比特大小。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">buildScratchSize</span> 在构建时需要暂付缓存的比特大小。</p></li>
</ul>
</section>
</section>
<section id="id17">
<h2>创建加速结构<a class="headerlink" href="#id17" title="Link to this heading">#</a></h2>
<section id="id18">
<h3>vkCreateAccelerationStructureKHR<a class="headerlink" href="#id18" title="Link to this heading">#</a></h3>
<p>通过调用 <code class="docutils literal notranslate"><span class="pre">vkCreateAccelerationStructureKHR</span></code> 创建加速结构</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="n">VkResult</span><span class="w"> </span><span class="nf">vkCreateAccelerationStructureKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureCreateInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="n">pCreateInfo</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAllocationCallbacks</span><span class="o">*</span><span class="w">                </span><span class="n">pAllocator</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkAccelerationStructureKHR</span><span class="o">*</span><span class="w">                 </span><span class="n">pAccelerationStructure</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">device</span> 用于创建加速结构的逻辑设备句柄。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pCreateInfo</span> 加速结构的构建信息。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pAllocator</span> 分配器。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pAccelerationStructure</span> 创建的目标加速结构句柄。</p></li>
</ul>
<p>加速结构仅仅用于创建一个具有特定形状的物体。可以构建进入加速结构的几何数量和类型是通过 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureCreateInfoKHR</span></code> 来指定。</p>
<p>之后往加速结构内部填入数据和绑定内存是通过调用 <code class="docutils literal notranslate"><span class="pre">vkCmdBuildAccelerationStructuresKHR</span></code> 、 <code class="docutils literal notranslate"><span class="pre">vkBuildAccelerationStructuresKHR</span></code> 、 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureKHR</span></code> 和 <code class="docutils literal notranslate"><span class="pre">vkCopyAccelerationStructureKHR</span></code> 函数实现的。</p>
<p>在将缓存输入构建加速结构指令构建加速结构时，如何构建加速结构是设备自己内部实现。</p>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>必须激活 <code class="docutils literal notranslate"><span class="pre">accelerationStructure</span></code> 特性。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureCreateInfoKHR::deviceAddress</span></code> 不是 <code class="docutils literal notranslate"><span class="pre">0</span></code> 的话，需要激活 <code class="docutils literal notranslate"><span class="pre">accelerationStructureCaptureReplay</span></code> 特性。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">device</span></code> 是从多个物理设备建立的话，需要激活 <code class="docutils literal notranslate"><span class="pre">bufferDeviceAddressMultiDevice</span></code> 特性。</p></li>
</ul>
</div>
</section>
<section id="vkaccelerationstructurecreateinfokhr">
<h3>VkAccelerationStructureCreateInfoKHR<a class="headerlink" href="#vkaccelerationstructurecreateinfokhr" title="Link to this heading">#</a></h3>
<p>对应调用 <code class="docutils literal notranslate"><span class="pre">vkCreateAccelerationStructureKHR</span></code> 时，需要设置对应的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureCreateInfoKHR</span></code> 创建信息。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAccelerationStructureCreateInfoKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">                          </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w">                              </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkAccelerationStructureCreateFlagsKHR</span><span class="w">    </span><span class="n">createFlags</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkBuffer</span><span class="w">                                 </span><span class="n">buffer</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkDeviceSize</span><span class="w">                             </span><span class="n">offset</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkDeviceSize</span><span class="w">                             </span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkAccelerationStructureTypeKHR</span><span class="w">           </span><span class="n">type</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkDeviceAddress</span><span class="w">                          </span><span class="n">deviceAddress</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureCreateInfoKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须是 <code class="docutils literal notranslate"><span class="pre">VkStructureType::VK_STRUCTURE_TYPE_ACCELERATION_STRUCTURE_CREATE_INFO_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureMotionInfoNV</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VkOpaqueCaptureDescriptorDataCreateInfoEXT</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">createFlags</span> 是 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureCreateFlagBitsKHR</span></code> 的位域，用于创建加速结构时指定附加参数。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">buffer</span> 加速结构将会存储的目标缓存。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">offset</span> 对于目标缓存的起始地址的比特偏移，在目标缓存的此偏移位置之后存储加速结构。偏移值必须是 <code class="docutils literal notranslate"><span class="pre">256</span></code> 的倍数。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">size</span> 加速结构需要的大小。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">type</span> <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureTypeKHR</span></code> 枚举值，用于创建的加速结构类型。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">deviceAddress</span> 如果使用 <code class="docutils literal notranslate"><span class="pre">accelerationStructureCaptureReplay</span></code> 特性，需要该加速结构请求的设备地址。</p></li>
</ul>
<p>如果 <code class="docutils literal notranslate"><span class="pre">deviceAddress</span></code> 为 <code class="docutils literal notranslate"><span class="pre">0</span></code> 的话，表示没有指定请求地址。</p>
<p>如果 <code class="docutils literal notranslate"><span class="pre">deviceAddress</span></code> 不为 <code class="docutils literal notranslate"><span class="pre">0</span></code> 的话，其地址需要与 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 相对应。</p>
<p>应用应该避免在同一进程中使用应用提供的地址和设备实现提供的地址，这是为了减少 <code class="docutils literal notranslate"><span class="pre">VK_ERROR_INVALID_OPAQUE_CAPTURE_ADDRESS_KHR</span></code> 错误出现的可能性。</p>
<div class="note admonition">
<p class="admonition-title">备注</p>
<p>一个预期的用法是将追踪捕获、回放工具，在使用 <code class="docutils literal notranslate"><span class="pre">VK_BUFFER_USAGE_SHADER_DEVICE_ADDRESS_BIT</span></code> 位域创建的所有缓存上添加 <code class="docutils literal notranslate"><span class="pre">VK_BUFFER_CREATE_DEVICE_ADDRESS_CAPTURE_REPLAY_BIT</span></code> 位域，并且在那些 <code class="docutils literal notranslate"><span class="pre">deviceAddress</span></code> 不是 <code class="docutils literal notranslate"><span class="pre">0</span></code> 的
加速结构所对应的所有用于存储的缓存上增加 <code class="docutils literal notranslate"><span class="pre">VK_BUFFER_USAGE_SHADER_DEVICE_ADDRESS_BIT</span></code> 位域。这也就意味着在应用还没有需要增加 <code class="docutils literal notranslate"><span class="pre">VK_MEMORY_ALLOCATE_DEVICE_ADDRESS_BIT</span></code> 位域时，工具需要对于内存分配增加 <code class="docutils literal notranslate"><span class="pre">VK_MEMORY_ALLOCATE_DEVICE_ADDRESS_BIT</span></code> 位域。
在捕获期间，工具将会保存捕获追踪到的设备地址。在回放期间，缓存将会根据原始地址创建，所以任何在追踪数据中存储的地址值将会一直处于有效状态。</p>
<p>驱动实现比较喜欢将这些缓存在 <code class="docutils literal notranslate"><span class="pre">GPU</span></code> 地址空间上进行分解，所以正常的内存分配将不会使用这些分解内存。为了避免地址空间分配冲突，应用或工具需要避免在 <code class="docutils literal notranslate"><span class="pre">VK_BUFFER_CREATE_DEVICE_ADDRESS_CAPTURE_REPLAY_BIT</span></code> 缓存上混合使用应用和驱动提供的地址。</p>
</div>
<p>应用应该使用除了 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_GENERIC_KHR</span></code> 之外的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureTypeKHR</span></code> 类型来创建加速结构</p>
<div class="note admonition">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_GENERIC_KHR</span></code> 本意是给 <code class="docutils literal notranslate"><span class="pre">API</span></code> 转换层（ <code class="docutils literal notranslate"><span class="pre">API</span> <span class="pre">translation</span> <span class="pre">layers</span></code> ）使用的。 该类型可以在你创建加速结构时不清楚创建的是顶层加速结构还是底层加速结构时使用。在构建时真正的加速结构类型必须指定为 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_TOP_LEVEL_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_BOTTOM_LEVEL_KHR</span></code> 。</p>
</div>
<p>如果加速结构将作为构建的目标，加速结构需要的大小可以通过 <code class="docutils literal notranslate"><span class="pre">vkGetAccelerationStructureBuildSizesKHR</span></code> 获取。如果加速结构用于压缩拷贝的话， <code class="docutils literal notranslate"><span class="pre">vkCmdWriteAccelerationStructuresPropertiesKHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">vkWriteAccelerationStructuresPropertiesKHR</span></code> 可以用于获取需要的压缩大小。</p>
<p>如果加速结构用于构建 <code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_MOTION_BIT_NV</span></code> 的话，其 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureCreateInfoKHR::createFlags</span></code> 必须包含 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_CREATE_MOTION_BIT_NV</span></code> ，并且 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureCreateInfoKHR::pNext</span></code> 中增加 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureMotionInfoNV</span></code> 作为构建对象的原始数据。</p>
<div class="tip admonition">
<p class="admonition-title">VkAccelerationStructureMotionInfoNV 和 VK_BUILD_ACCELERATION_STRUCTURE_MOTION_BIT_NV</p>
<p>这两个属于 <code class="docutils literal notranslate"><span class="pre">VK_NV_ray_tracing_motion_blur</span></code> ，是 <code class="docutils literal notranslate"><span class="pre">NVIDIA</span></code> 的扩展，并不是 <code class="docutils literal notranslate"><span class="pre">KHR</span></code> 扩展，目前先忽略。</p>
</div>
</section>
<section id="vkaccelerationstructuretypekhr">
<h3>VkAccelerationStructureTypeKHR<a class="headerlink" href="#vkaccelerationstructuretypekhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureCreateInfoKHR::type</span></code> 用于设定加速结构的类型，支持的类型为：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">VkAccelerationStructureTypeKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VK_ACCELERATION_STRUCTURE_TYPE_TOP_LEVEL_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_ACCELERATION_STRUCTURE_TYPE_BOTTOM_LEVEL_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_ACCELERATION_STRUCTURE_TYPE_GENERIC_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureTypeKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_ACCELERATION_STRUCTURE_TYPE_TOP_LEVEL_KHR</span> 表示包含实体（引用底层加速结构）的顶层加速结构。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_ACCELERATION_STRUCTURE_TYPE_BOTTOM_LEVEL_KHR</span> 表示包含用于求交的 <code class="docutils literal notranslate"><span class="pre">AABBs</span></code> 或几何数据的底层加速结构。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_ACCELERATION_STRUCTURE_TYPE_GENERIC_KHR</span> 表示在加速结构创建时不知道是什么类型的，具体的类型需要在构建时确定，并且构建时必须确定是顶层加速结构还是底层加速结构。</p></li>
</ul>
</section>
<section id="vkaccelerationstructurecreateflagbitskhr">
<h3>VkAccelerationStructureCreateFlagBitsKHR<a class="headerlink" href="#vkaccelerationstructurecreateflagbitskhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureCreateInfoKHR::createFlags</span></code> 可以设置的标志位域如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">VkAccelerationStructureCreateFlagBitsKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VK_ACCELERATION_STRUCTURE_CREATE_DEVICE_ADDRESS_CAPTURE_REPLAY_BIT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00000001</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureCreateFlagBitsKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_ACCELERATION_STRUCTURE_CREATE_DEVICE_ADDRESS_CAPTURE_REPLAY_BIT_KHR</span> 表示加速结构的地址可以被之后的一系列执行存储和重用。</p></li>
</ul>
</section>
</section>
<section id="id19">
<h2>获取64位加速结构设备地址<a class="headerlink" href="#id19" title="Link to this heading">#</a></h2>
<section id="id20">
<h3>vkGetAccelerationStructureDeviceAddressKHR<a class="headerlink" href="#id20" title="Link to this heading">#</a></h3>
<p>获取 <code class="docutils literal notranslate"><span class="pre">64</span></code> 位的加速结构设备地址，通过调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="n">VkDeviceAddress</span><span class="w"> </span><span class="nf">vkGetAccelerationStructureDeviceAddressKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureDeviceAddressInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="n">pInfo</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">device</span> 用于之前创建加速结构的逻辑设备句柄。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pInfo</span> 指向用于设定获取目标加速结构地址的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureDeviceAddressInfoKHR</span></code> 结构体。</p></li>
</ul>
<p>该函数返回的 <code class="docutils literal notranslate"><span class="pre">64</span></code> 位的加速结构地址，可以用于与加速结构相关的设备和着色器操作，比如光线遍历和绑定加速结构。</p>
<p>如果加速结构在创建时 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureCreateInfoKHR::deviceAddress</span></code> 给的是有效设备地址，该函数将返回与之相同的设备地址。</p>
<p>如果加速结构在创建时 <code class="docutils literal notranslate"><span class="pre">type</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_GENERIC_KHR</span></code> 时，该函数返回的地址在使用相同的 <code class="docutils literal notranslate"><span class="pre">VkBuffer</span></code> 分配的 <code class="docutils literal notranslate"><span class="pre">VK_ACCELERATION_STRUCTURE_TYPE_GENERIC_KHR</span></code> 的类型加速结构必须与其他加速度结构的相对偏移量一致。</p>
<p>返回的地址必须以 <code class="docutils literal notranslate"><span class="pre">256</span></code> 比特对齐。</p>
</section>
<section id="vkaccelerationstructuredeviceaddressinfokhr">
<h3>VkAccelerationStructureDeviceAddressInfoKHR<a class="headerlink" href="#vkaccelerationstructuredeviceaddressinfokhr" title="Link to this heading">#</a></h3>
<p>相应的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureDeviceAddressInfoKHR</span></code> 定义为：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAccelerationStructureDeviceAddressInfoKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">               </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w">                   </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkAccelerationStructureKHR</span><span class="w">    </span><span class="n">accelerationStructure</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureDeviceAddressInfoKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须为 <code class="docutils literal notranslate"><span class="pre">VK_STRUCTURE_TYPE_ACCELERATION_STRUCTURE_DEVICE_ADDRESS_INFO_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向其他结构体来扩展该结构体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">accelerationStructure</span> 设定要获取设备地址的目标加速结构。</p></li>
</ul>
</section>
</section>
<section id="id21">
<h2>销毁加速结构<a class="headerlink" href="#id21" title="Link to this heading">#</a></h2>
<section id="id22">
<h3>vkDestroyAccelerationStructureKHR<a class="headerlink" href="#id22" title="Link to this heading">#</a></h3>
<p>销毁一个加速结构，通过调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vkDestroyAccelerationStructureKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkAccelerationStructureKHR</span><span class="w">                  </span><span class="n">accelerationStructure</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAllocationCallbacks</span><span class="o">*</span><span class="w">                </span><span class="n">pAllocator</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">device</span> 用于销毁加速结构的逻辑设备句柄。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">accelerationStructure</span> 要销毁的加速结构句柄。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pAllocator</span> 指定使用 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端的内存分配器。</p></li>
</ul>
</section>
</section>
<section id="id23">
<h2>构建加速结构<a class="headerlink" href="#id23" title="Link to this heading">#</a></h2>
<section id="id24">
<h3>vkCmdBuildAccelerationStructuresKHR<a class="headerlink" href="#id24" title="Link to this heading">#</a></h3>
<p>构建加速结构调用  <code class="docutils literal notranslate"><span class="pre">vkCmdBuildAccelerationStructuresKHR</span></code> :</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vkCmdBuildAccelerationStructuresKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkCommandBuffer</span><span class="w">                             </span><span class="n">commandBuffer</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w">                                    </span><span class="n">infoCount</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureBuildGeometryInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="n">pInfos</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureBuildRangeInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="n">ppBuildRangeInfos</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">commandBuffer</span> 指定在哪个指令缓存中记录指令。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">infoCount</span> 只是要构建的加速结构的个数。该个数为 <code class="docutils literal notranslate"><span class="pre">pInfos</span></code> 和 <code class="docutils literal notranslate"><span class="pre">ppBuildRangeInfos</span></code> 需要提供的个数。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pInfos</span> 是类型为 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR</span></code> 数量为 <code class="docutils literal notranslate"><span class="pre">infoCount</span></code> 的数组，用于定义构建的每一个加速结构中的几何体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">ppBuildRangeInfos</span> 是类型为 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildRangeInfoKHR</span></code> 数量为 <code class="docutils literal notranslate"><span class="pre">infoCount</span></code> 的数组。每一个 <code class="docutils literal notranslate"><span class="pre">ppBuildRangeInfos[i]</span></code> 都是指向数量为 <code class="docutils literal notranslate"><span class="pre">pInfos[i].geometryCount</span></code> 类型为 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildRangeInfoKHR</span></code> 的数组，用于动态定义 <code class="docutils literal notranslate"><span class="pre">pInfos[i]</span></code> 中对应的几何数据在内存中偏移。</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">vkCmdBuildAccelerationStructuresKHR</span></code> 指令支持一次性构建多个加速结构，然而在每一个加速结构构建之间是没有隐含的顺序或同步的。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>这也就意味着应用不能在构建底层架结构或者实体加速结构（ <code class="docutils literal notranslate"><span class="pre">instance</span> <span class="pre">acceleration</span> <span class="pre">structures</span></code> ）的同一个 <code class="docutils literal notranslate"><span class="pre">vkCmdBuildAccelerationStructuresKHR</span></code> 构建指令中构建顶层加速结构。同时也不能在构建时在加速结构内存或暂付缓存上使用内存混叠。</p>
</div>
<div class="hint admonition">
<p class="admonition-title">实体加速结构</p>
<p>大概率是指 <code class="docutils literal notranslate"><span class="pre">pInfos</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryKHR*</span> <span class="pre">pGeometries</span></code> 成员中 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryInstancesDataKHR</span> <span class="pre">instances</span></code> 成员，用于构建实体加速结构。但在构建顶层加速结构是也会使用到 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryInstancesDataKHR</span> <span class="pre">instances</span></code> ，此处的实体加速结构是啥并不明确，待后文看看。</p>
</div>
<div class="note admonition">
<p class="admonition-title">内存混叠</p>
<p>内存混叠有点类似于 <code class="docutils literal notranslate"><span class="pre">C++</span></code> 的 <code class="docutils literal notranslate"><span class="pre">union</span></code> 。同一段内存可以被多个资源使用，多见于临时资源的覆盖，使得一段内存可以多次重复使用。</p>
</div>
<p>访问 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR::scratchData</span></code> 对应的暂付缓存的设备地址必须在 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_ACCELERATION_STRUCTURE_BUILD_BIT_KHR</span></code> 管线阶段使用 <code class="docutils literal notranslate"><span class="pre">VK_ACCESS_ACCELERATION_STRUCTURE_READ_BIT_KHR</span> <span class="pre">|</span> <span class="pre">VK_ACCESS_ACCELERATION_STRUCTURE_WRITE_BIT_KHR</span></code> 访问类型进行同步。
访问 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR::srcAccelerationStructure</span></code> 和 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR::dstAccelerationStructure</span></code> 时必须在 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_ACCELERATION_STRUCTURE_BUILD_BIT_KHR</span></code> 管线阶段使用 <code class="docutils literal notranslate"><span class="pre">VK_ACCESS_ACCELERATION_STRUCTURE_READ_BIT_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_ACCESS_ACCELERATION_STRUCTURE_WRITE_BIT_KHR</span></code> 访问类型进行同步较适当。</p>
<p>访问其他的 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::vertexData</span></code> 、 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::indexData</span></code> 、 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::transformData</span></code> 、 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryAabbsDataKHR::data</span></code> 和 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryInstancesDataKHR::data</span></code> 的输入缓存
时必须在 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_ACCELERATION_STRUCTURE_BUILD_BIT_KHR</span></code> 管线阶段使用 <code class="docutils literal notranslate"><span class="pre">VK_ACCESS_SHADER_READ_BIT</span></code> 访问类型进行同步。</p>
</section>
<section id="vkaccelerationstructurebuildrangeinfokhr">
<h3>VkAccelerationStructureBuildRangeInfoKHR<a class="headerlink" href="#vkaccelerationstructurebuildrangeinfokhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildRangeInfoKHR</span></code> 定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAccelerationStructureBuildRangeInfoKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">primitiveCount</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">primitiveOffset</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">firstVertex</span><span class="p">;</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">transformOffset</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureBuildRangeInfoKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">primitiveCount</span> 为对应的几何加速结构定义图元数量。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">primitiveOffset</span> 为图元在具体内存中的比特偏移。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">firstVertex</span> 为要构建的三角形几何体的第一个顶点的索引值。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">transformOffset</span> 为变换矩阵在具体内存中的比特偏移。</p></li>
</ul>
<p>图元的数量和图元偏移将会根据不同的 <code class="docutils literal notranslate"><span class="pre">VkGeometryTypeKHR</span></code> 有所不同：</p>
<ul class="simple">
<li><dl class="simple">
<dt>对于类型为 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_TRIANGLES_KHR</span></code> 的几何体， <code class="docutils literal notranslate"><span class="pre">primitiveCount</span></code> 是要构建的三角形数量，每个三角形被认为由三个顶点组成。</dt><dd><ul>
<li><p>如果几何体使用索引，将会从 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::indexData</span></code> 中使用 <code class="docutils literal notranslate"><span class="pre">primitiveCount</span></code> <span class="math notranslate nohighlight">\(\times3\)</span> 数量的索引数据，并从 <code class="docutils literal notranslate"><span class="pre">primitiveOffset</span></code> 偏移开始。获取顶点时，将会在索引值上加上 <code class="docutils literal notranslate"><span class="pre">firstVertex</span></code> 数量值。</p></li>
<li><p>如果几何体不使用索引，将会从 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::vertexData</span></code> 中使用 <code class="docutils literal notranslate"><span class="pre">primitiveCount</span></code> <span class="math notranslate nohighlight">\(\times3\)</span> 数量的顶点数据，并从 <code class="docutils literal notranslate"><span class="pre">primitiveOffset</span></code> <span class="math notranslate nohighlight">\(+\)</span> <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::vertexStride</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">firstVertex</span></code> 偏移开始。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::transformData</span></code> 不是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 的话， 将会从 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::transformData</span></code> 中在 <code class="docutils literal notranslate"><span class="pre">transformOffset</span></code> 偏移之后获取一个 <code class="docutils literal notranslate"><span class="pre">VkTransformMatrixKHR</span></code> 结构体数据。</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>对于类型为 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_AABBS_KHR</span></code> ， <code class="docutils literal notranslate"><span class="pre">primitiveCount</span></code> 是轴对齐包围盒的个数。将会从 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryAabbsDataKHR::data</span></code> 在 <code class="docutils literal notranslate"><span class="pre">primitiveOffset</span></code> 偏移之后获取 <code class="docutils literal notranslate"><span class="pre">primitiveCount</span></code> 个 <code class="docutils literal notranslate"><span class="pre">VkAabbPositionsKHR</span></code> 结构体数据。</p></li>
<li><p>对于类型为 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_INSTANCES_KHR</span></code> ， <code class="docutils literal notranslate"><span class="pre">primitiveCount</span></code> 是加速结构的个数。将会从 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryInstancesDataKHR::data</span></code> 在 <code class="docutils literal notranslate"><span class="pre">primitiveOffset</span></code> 偏移之后获取 <code class="docutils literal notranslate"><span class="pre">primitiveCount</span></code> 个 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureInstanceKHR</span></code> 结构体数据。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<blockquote>
<div><ul class="simple">
<li><p>对于类型为 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_TRIANGLES_KHR</span></code> ，如果几何体使用索引， <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::indexData</span></code> 必须是 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::indexType</span></code> 元素大小的倍数。</p></li>
<li><p>对于类型为 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_TRIANGLES_KHR</span></code> ，如果几何体不使用索引， <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::vertexData</span></code> 必须是 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::vertexFormat</span></code> 元素大小的倍数。</p></li>
<li><p>对于类型为 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_TRIANGLES_KHR</span></code> ， 对于 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryTrianglesDataKHR::transformData</span></code> 的偏移 <code class="docutils literal notranslate"><span class="pre">transformOffset</span></code> 必须是 <code class="docutils literal notranslate"><span class="pre">16</span></code> 的倍数。</p></li>
<li><p>对于类型为 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_AABBS_KHR</span></code> ， 对于 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryAabbsDataKHR::data</span></code> 的偏移 <code class="docutils literal notranslate"><span class="pre">primitiveOffset</span></code> 必须是 <code class="docutils literal notranslate"><span class="pre">8</span></code> 的倍数。</p></li>
<li><p>对于类型为 <code class="docutils literal notranslate"><span class="pre">VK_GEOMETRY_TYPE_INSTANCES_KHR</span></code> ， 对于 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureGeometryInstancesDataKHR::data</span></code> 的偏移 <code class="docutils literal notranslate"><span class="pre">primitiveOffset</span></code> 必须是 <code class="docutils literal notranslate"><span class="pre">16</span></code> 的倍数。</p></li>
</ul>
</div></blockquote>
</div>
</section>
</section>
<section id="id25">
<h2>拷贝加速结构<a class="headerlink" href="#id25" title="Link to this heading">#</a></h2>
<p>还有一个用于拷贝加速结构的命令而不更新其内容。加速结构可以进行压缩来获得更高的性能。在拷贝前，应用必须先查询加速结构的大小。</p>
<section id="id26">
<h3>vkCmdWriteAccelerationStructuresPropertiesKHR<a class="headerlink" href="#id26" title="Link to this heading">#</a></h3>
<p>查询加速结构的大小调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vkCmdWriteAccelerationStructuresPropertiesKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkCommandBuffer</span><span class="w">                             </span><span class="n">commandBuffer</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w">                                    </span><span class="n">accelerationStructureCount</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureKHR</span><span class="o">*</span><span class="w">           </span><span class="n">pAccelerationStructures</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkQueryType</span><span class="w">                                 </span><span class="n">queryType</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkQueryPool</span><span class="w">                                 </span><span class="n">queryPool</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w">                                    </span><span class="n">firstQuery</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">commandBuffer</span> 用于记录该指令的命令缓存。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">accelerationStructureCount</span> 要查询的加速结构的数量。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pAccelerationStructures</span> 指向构建完成的加速结构数组。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">queryType</span> 其为 <code class="docutils literal notranslate"><span class="pre">VkQueryType</span></code> 中的值，用于管理查询池的查询类型。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">queryPool</span> 用于管理查询结果的查询池。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">firstQuery</span> 在查询池中包含 <code class="docutils literal notranslate"><span class="pre">accelerationStructureCount</span></code> 数量的查询结果的第一个查询索引。</p></li>
</ul>
<p>访问 <code class="docutils literal notranslate"><span class="pre">pAccelerationStructures</span></code> 中的任何一个加速结构都需要在 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_2_ACCELERATION_STRUCTURE_COPY_BIT_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_ACCELERATION_STRUCTURE_BUILD_BIT_KHR</span></code> 管线阶段和 <code class="docutils literal notranslate"><span class="pre">VK_ACCESS_ACCELERATION_STRUCTURE_READ_BIT_KHR</span></code> 访问类型进行同步。</p>
<ul class="simple">
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">queryType</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_QUERY_TYPE_ACCELERATION_STRUCTURE_COMPACTED_SIZE_KHR</span></code> 的话，则返回的查询值就是加速结构压缩之后需要的比特数量。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">queryType</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_QUERY_TYPE_ACCELERATION_STRUCTURE_SERIALIZATION_SIZE_KHR</span></code> 的话，则返回的查询值就是加速结构序列化之后需要的比特数量。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>需要激活 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructureFeaturesKHR::accelerationStructure</span></code> 特性</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">queryPool</span></code> 创建时的 <code class="docutils literal notranslate"><span class="pre">queryType</span></code> 必须与 <code class="docutils literal notranslate"><span class="pre">vkCmdWriteAccelerationStructuresPropertiesKHR::queryType</span></code> 相匹配。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pAccelerationStructures</span></code> 中的加速结构在必须通过 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 绑定到了设备内存上。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pAccelerationStructures</span></code> 中的加速结构在调用该指令之前必须已经构建完成。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">queryType</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_QUERY_TYPE_ACCELERATION_STRUCTURE_COMPACTED_SIZE_KHR</span></code> 的话， <code class="docutils literal notranslate"><span class="pre">pAccelerationStructures</span></code> 中所有的加速结构必须根据 <code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_ALLOW_COMPACTION_BIT_KHR</span></code> 构建的。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">queryType</span></code> 必须是 <code class="docutils literal notranslate"><span class="pre">VK_QUERY_TYPE_ACCELERATION_STRUCTURE_SIZE_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_QUERY_TYPE_ACCELERATION_STRUCTURE_SERIALIZATION_BOTTOM_LEVEL_POINTERS_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_QUERY_TYPE_ACCELERATION_STRUCTURE_COMPACTED_SIZE_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_QUERY_TYPE_ACCELERATION_STRUCTURE_SERIALIZATION_SIZE_KHR</span></code> 。</p></li>
</ul>
</div>
</section>
<section id="id27">
<h3>vkCmdCopyAccelerationStructureKHR<a class="headerlink" href="#id27" title="Link to this heading">#</a></h3>
<p>拷贝加速结构调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vkCmdCopyAccelerationStructureKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkCommandBuffer</span><span class="w">                             </span><span class="n">commandBuffer</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkCopyAccelerationStructureInfoKHR</span><span class="o">*</span><span class="w">   </span><span class="n">pInfo</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">commandBuffer</span> 用于记录该指令的命令缓存。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pInfo</span> 指向 <code class="docutils literal notranslate"><span class="pre">VkCopyAccelerationStructureInfoKHR</span></code> 结构体，用于定义拷贝操作。</p></li>
</ul>
<p>该指令将会根据 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;mode</span></code> 中的模式将 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src</span></code> 的加速结构拷贝至 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst</span></code> 加速结构中。</p>
<p>访问 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src</span></code> 和 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst</span></code> 必须使用 <code class="docutils literal notranslate"><span class="pre">VK_ACCESS_ACCELERATION_STRUCTURE_READ_BIT_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_ACCESS_ACCELERATION_STRUCTURE_WRITE_BIT_KHR</span></code> 访问类型，在 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_2_ACCELERATION_STRUCTURE_COPY_BIT_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_ACCELERATION_STRUCTURE_BUILD_BIT_KHR</span></code> 管线阶段进行同步。</p>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>需要激活 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructureFeaturesKHR::accelerationStructure</span></code> 特性</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src</span></code> 中的加速结构在必须通过 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 绑定到了设备内存上。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst</span></code> 中的加速结构在必须通过 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 绑定到了设备内存上。</p></li>
</ul>
</div>
</section>
<section id="vkcopyaccelerationstructureinfokhr">
<h3>VkCopyAccelerationStructureInfoKHR<a class="headerlink" href="#vkcopyaccelerationstructureinfokhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkCopyAccelerationStructureInfoKHR</span></code> 定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkCopyAccelerationStructureInfoKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">                       </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w">                           </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkAccelerationStructureKHR</span><span class="w">            </span><span class="n">src</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkAccelerationStructureKHR</span><span class="w">            </span><span class="n">dst</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkCopyAccelerationStructureModeKHR</span><span class="w">    </span><span class="n">mode</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkCopyAccelerationStructureInfoKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须是 <code class="docutils literal notranslate"><span class="pre">VkStructureType::VK_STRUCTURE_TYPE_COPY_ACCELERATION_STRUCTURE_INFO_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向其他结构体来扩展该结构体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">src</span> 拷贝的源加速结构。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">dst</span> 拷贝的目标加速结构。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">mode</span> 用于在拷贝时增加额外操作。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mode</span></code> 只能是 <code class="docutils literal notranslate"><span class="pre">VK_COPY_ACCELERATION_STRUCTURE_MODE_COMPACT_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_COPY_ACCELERATION_STRUCTURE_MODE_CLONE_KHR</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code> 的源加速结构在执行该指令前必须构建完成 。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">mode</span></code> 是 <code class="docutils literal notranslate"><span class="pre">VK_COPY_ACCELERATION_STRUCTURE_MODE_COMPACT_KHR</span></code> 的话， <code class="docutils literal notranslate"><span class="pre">src</span></code> 在构建时指定 <code class="docutils literal notranslate"><span class="pre">VK_BUILD_ACCELERATION_STRUCTURE_ALLOW_COMPACTION_BIT_KHR</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code> 中的加速结构在必须通过 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 绑定到了设备内存上。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dst</span></code> 中的加速结构在必须通过 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 绑定到了设备内存上。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dst</span></code> 中的加速结构在必须通过 <code class="docutils literal notranslate"><span class="pre">vkBindAccelerationStructureMemoryNV</span></code> 绑定到一个 <code class="docutils literal notranslate"><span class="pre">VkDeviceMemory</span></code> 设备内存上。<span class="sd-sphinx-override sd-badge sd-bg-danger sd-bg-text-danger">该条存疑</span></p></li>
</ul>
</div>
<p>拷贝时 <code class="docutils literal notranslate"><span class="pre">mode</span></code> 可能的值定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">VkCopyAccelerationStructureModeKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VK_COPY_ACCELERATION_STRUCTURE_MODE_CLONE_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_COPY_ACCELERATION_STRUCTURE_MODE_COMPACT_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_COPY_ACCELERATION_STRUCTURE_MODE_SERIALIZE_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_COPY_ACCELERATION_STRUCTURE_MODE_DESERIALIZE_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkCopyAccelerationStructureModeKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_COPY_ACCELERATION_STRUCTURE_MODE_CLONE_KHR</span> 将 <code class="docutils literal notranslate"><span class="pre">src</span></code> 中的加速结构直接拷贝至 <code class="docutils literal notranslate"><span class="pre">dst</span></code> 中，其中 <code class="docutils literal notranslate"><span class="pre">dst</span></code> 的创建参数必须和 <code class="docutils literal notranslate"><span class="pre">src</span></code> 的创建参数一样。如果 <code class="docutils literal notranslate"><span class="pre">src</span></code> 引用了其他加速结构， <code class="docutils literal notranslate"><span class="pre">dst</span></code> 也需要进行相应的匹配。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_COPY_ACCELERATION_STRUCTURE_MODE_COMPACT_KHR</span> 将 <code class="docutils literal notranslate"><span class="pre">src</span></code> 中的加速结构压缩版本拷贝至 <code class="docutils literal notranslate"><span class="pre">dst</span></code> 中，其中 <code class="docutils literal notranslate"><span class="pre">dst</span></code> 的加速结构大小最起码需要与 <code class="docutils literal notranslate"><span class="pre">src</span></code> 构建之后使用 <code class="docutils literal notranslate"><span class="pre">vkCmdWriteAccelerationStructuresPropertiesKHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">vkWriteAccelerationStructuresPropertiesKHR</span></code> 获取到的大小一致。如果 <code class="docutils literal notranslate"><span class="pre">src</span></code> 引用了其他加速结构， <code class="docutils literal notranslate"><span class="pre">dst</span></code> 也需要进行相应的匹配。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_COPY_ACCELERATION_STRUCTURE_MODE_SERIALIZE_KHR</span> 将加速结构序列化到一个半透明的格式中，可以在兼容实现中加载。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_COPY_ACCELERATION_STRUCTURE_MODE_DESERIALIZE_KHR</span> 将半透明的格式反序列化到中加速结构的缓存中。</p></li>
</ul>
</section>
<section id="id28">
<h3>vkCmdCopyAccelerationStructureToMemoryKHR<a class="headerlink" href="#id28" title="Link to this heading">#</a></h3>
<p>将加速结构拷贝至设备内存中调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vkCmdCopyAccelerationStructureToMemoryKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkCommandBuffer</span><span class="w">                             </span><span class="n">commandBuffer</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkCopyAccelerationStructureToMemoryInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="n">pInfo</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">commandBuffer</span> 用于记录该指令的命令缓存。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pInfo</span> 定义拷贝操作。</p></li>
</ul>
<p>访问 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src</span></code> 的加速结构时必须在 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_2_ACCELERATION_STRUCTURE_COPY_BIT_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_ACCELERATION_STRUCTURE_BUILD_BIT_KHR</span></code> 管线阶段使用 <code class="docutils literal notranslate"><span class="pre">VK_ACCESS_ACCELERATION_STRUCTURE_READ_BIT_KHR</span></code> 访问类型进行同步。
访问 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst.deviceAddress</span></code> 的加速结构时必须在 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_2_ACCELERATION_STRUCTURE_COPY_BIT_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_ACCELERATION_STRUCTURE_BUILD_BIT_KHR</span></code> 管线阶段使用 <code class="docutils literal notranslate"><span class="pre">VK_ACCESS_TRANSFER_WRITE_BIT</span></code> 访问类型进行同步。</p>
<p>该指令与 <code class="docutils literal notranslate"><span class="pre">vkCopyAccelerationStructureToMemoryKHR</span></code> 函数的结果相似，只不过 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureToMemoryKHR</span></code> 是写入 <code class="docutils literal notranslate"><span class="pre">device</span></code> 地址中，并且在 <code class="docutils literal notranslate"><span class="pre">device</span></code> 端执行而不是在 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端。这两个指令函数的输出结果不一定每一个比特位都相同，但是在使用上 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyMemoryToAccelerationStructureKHR</span></code> 和 <code class="docutils literal notranslate"><span class="pre">vkCopyMemoryToAccelerationStructureKHR</span></code> 是一样的。</p>
<p>序列化数据头结构如下：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">VK_UUID_SIZE</span></code> 比特数据与 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceIDProperties::driverUUID</span></code> 相匹配。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VK_UUID_SIZE</span></code> 比特数据使用 <code class="docutils literal notranslate"><span class="pre">vkGetDeviceAccelerationStructureCompatibilityKHR</span></code> 来进行兼容性对照。</p></li>
<li><p>一个 <code class="docutils literal notranslate"><span class="pre">64</span></code> 位整型的总大小与 <code class="docutils literal notranslate"><span class="pre">VK_QUERY_TYPE_ACCELERATION_STRUCTURE_SERIALIZATION_SIZE_KHR</span></code> 查询到的相匹配。</p></li>
<li><p>一个 <code class="docutils literal notranslate"><span class="pre">64</span></code> 位整型的反序列化大小最终将会传入 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureCreateInfoKHR::size</span></code> 。</p></li>
<li><p>一个 <code class="docutils literal notranslate"><span class="pre">64</span></code> 位整型表示加速结构句柄的数量。该数量与使用 <code class="docutils literal notranslate"><span class="pre">VK_QUERY_TYPE_ACCELERATION_STRUCTURE_SERIALIZATION_BOTTOM_LEVEL_POINTERS_KHR</span></code> 查询到的数量相匹配。对于底层加速结构来说是 <code class="docutils literal notranslate"><span class="pre">0</span></code> ，但对于顶层加速结构来说是驱动实现相关的。句柄的数量和顺序与我们用于构建时使用的加速结构可能会不匹配。</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">vkGetAccelerationStructureDeviceAddressKHR</span></code> 返回相匹配的句柄将会在缓存中根据数量紧凑排布。应用期望在反序列化时将句柄与应用生成的底层加速结构进行映射。将会根据 <code class="docutils literal notranslate"><span class="pre">host</span></code> 端的字节序列书序写入或读出缓存的序列化数据。</p>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>需要激活 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructureFeaturesKHR::accelerationStructure</span></code> 特性。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst.deviceAddress</span></code> 必须是一个缓存绑定到设备内内存的有效设备地址。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst.deviceAddress</span></code> 必须是 <code class="docutils literal notranslate"><span class="pre">256</span></code> 比特对齐。</p></li>
<li><p>如果缓存指向的 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst.deviceAddress</span></code> 是非稀疏则必须绑定到一个单一的 <code class="docutils literal notranslate"><span class="pre">VkDeviceMemory</span></code> 对象上。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src</span></code> 使用到的 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 必须绑定到一个设备内存中。</p></li>
</ul>
</div>
</section>
<section id="vkcopyaccelerationstructuretomemoryinfokhr">
<h3>VkCopyAccelerationStructureToMemoryInfoKHR<a class="headerlink" href="#vkcopyaccelerationstructuretomemoryinfokhr" title="Link to this heading">#</a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkCopyAccelerationStructureToMemoryInfoKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">                       </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w">                           </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkAccelerationStructureKHR</span><span class="w">            </span><span class="n">src</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkDeviceOrHostAddressKHR</span><span class="w">              </span><span class="n">dst</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkCopyAccelerationStructureModeKHR</span><span class="w">    </span><span class="n">mode</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkCopyAccelerationStructureToMemoryInfoKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须是 <code class="docutils literal notranslate"><span class="pre">VkStructureType::VK_STRUCTURE_TYPE_COPY_ACCELERATION_STRUCTURE_TO_MEMORY_INFO_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向其他结构体来扩展该结构体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">src</span> 拷贝的源加速结构。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">dst</span> 是拷贝目标 <code class="docutils literal notranslate"><span class="pre">host</span></code> 或 <code class="docutils literal notranslate"><span class="pre">device</span></code> 内存地址。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">mode</span> 是拷贝时的额外参数。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code> 的加速结构必须在执行拷贝指令前创建完成。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dst</span></code> 的内存大小最起码需要与使用 <code class="docutils literal notranslate"><span class="pre">VK_QUERY_TYPE_ACCELERATION_STRUCTURE_SERIALIZATION_SIZE_KHR</span></code> 查询类型调用 <code class="docutils literal notranslate"><span class="pre">vkWriteAccelerationStructuresPropertiesKHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">vkCmdWriteAccelerationStructuresPropertiesKHR</span></code> 函数获取到 <code class="docutils literal notranslate"><span class="pre">src</span></code> 的序列化大小相同。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mode</span></code> 只能是 <code class="docutils literal notranslate"><span class="pre">VK_COPY_ACCELERATION_STRUCTURE_MODE_SERIALIZE_KHR</span></code> 。</p></li>
</ul>
</div>
</section>
<section id="id29">
<h3>vkCmdCopyMemoryToAccelerationStructureKHR<a class="headerlink" href="#id29" title="Link to this heading">#</a></h3>
<p>将设备内存拷贝至加速结构，调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vkCmdCopyMemoryToAccelerationStructureKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkCommandBuffer</span><span class="w">                             </span><span class="n">commandBuffer</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkCopyMemoryToAccelerationStructureInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="n">pInfo</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">commandBuffer</span> 用于记录该指令的命令缓存。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pInfo</span> 定义拷贝操作。</p></li>
</ul>
<p>访问 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst</span></code> 的加速结构时必须在 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_2_ACCELERATION_STRUCTURE_COPY_BIT_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_ACCELERATION_STRUCTURE_BUILD_BIT_KHR</span></code> 管线阶段使用 <code class="docutils literal notranslate"><span class="pre">VK_ACCESS_ACCELERATION_STRUCTURE_WRITE_BIT_KHR</span></code> 访问类型进行同步。
访问 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src.deviceAddress</span></code> 的地址时必须在 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_2_ACCELERATION_STRUCTURE_COPY_BIT_KHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">VK_PIPELINE_STAGE_ACCELERATION_STRUCTURE_BUILD_BIT_KHR</span></code> 管线阶段使用 <code class="docutils literal notranslate"><span class="pre">VK_ACCESS_TRANSFER_READ_BIT</span></code> 访问类型进行同步。</p>
<p>该指令支持使用 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureToMemoryKHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">vkCopyAccelerationStructureToMemoryKHR</span></code> 拷贝的目标内存地址。</p>
<p>该指令的的反序列化将会作为 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureToMemoryKHR</span></code> 输入。</p>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>需要激活 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructureFeaturesKHR::accelerationStructure</span></code> 特性。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src.deviceAddress</span></code> 必须是已经绑定到设备内存的缓存地址。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src.deviceAddress</span></code> 必须是 <code class="docutils literal notranslate"><span class="pre">256</span></code> 比特对齐。</p></li>
<li><p>如果缓存指向的 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src.deviceAddress</span></code> 是非稀疏则必须绑定到一个单一的 <code class="docutils literal notranslate"><span class="pre">VkDeviceMemory</span></code> 对象上。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst</span></code> 使用到的 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 必须绑定到一个设备内存中。</p></li>
</ul>
</div>
</section>
<section id="vkcopymemorytoaccelerationstructureinfokhr">
<h3>VkCopyMemoryToAccelerationStructureInfoKHR<a class="headerlink" href="#vkcopymemorytoaccelerationstructureinfokhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkCopyMemoryToAccelerationStructureInfoKHR</span></code> 结构体定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkCopyMemoryToAccelerationStructureInfoKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">                       </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w">                           </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkDeviceOrHostAddressConstKHR</span><span class="w">         </span><span class="n">src</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkAccelerationStructureKHR</span><span class="w">            </span><span class="n">dst</span><span class="p">;</span>
<span class="w">    </span><span class="n">VkCopyAccelerationStructureModeKHR</span><span class="w">    </span><span class="n">mode</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkCopyMemoryToAccelerationStructureInfoKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须是 <code class="docutils literal notranslate"><span class="pre">VkStructureType::VK_STRUCTURE_TYPE_COPY_MEMORY_TO_ACCELERATION_STRUCTURE_INFO_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向其他结构体来扩展该结构体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">src</span> 拷贝的源 <code class="docutils literal notranslate"><span class="pre">host</span></code> 或 <code class="docutils literal notranslate"><span class="pre">device</span></code> 内存地址。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">dst</span> 是拷贝目标加速结构。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">mode</span> 是拷贝时的额外参数。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code> 的内存指针必须包含之前使用 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureToMemoryKHR</span></code> 获取的序列化数据。可以用该函数将加速结构进行数据重定位移动。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mode</span></code> 只能是 <code class="docutils literal notranslate"><span class="pre">VK_COPY_ACCELERATION_STRUCTURE_MODE_DESERIALIZE_KHR</span></code> 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">src</span></code> 中的数据必须与 <code class="docutils literal notranslate"><span class="pre">vkGetDeviceAccelerationStructureCompatibilityKHR</span></code> 返回的目标物理设备有兼容的格式。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dst</span></code> 创建的大小需要大于等于 <code class="docutils literal notranslate"><span class="pre">src</span></code> 序列化的大小。</p></li>
</ul>
</div>
</section>
<section id="id30">
<h3>vkGetDeviceAccelerationStructureCompatibilityKHR<a class="headerlink" href="#id30" title="Link to this heading">#</a></h3>
<p>为了检查序列化的加速结构是否与当前设备兼容：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">vkGetDeviceAccelerationStructureCompatibilityKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureVersionInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="n">pVersionInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkAccelerationStructureCompatibilityKHR</span><span class="o">*</span><span class="w">    </span><span class="n">pCompatibility</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">device</span> 用于检查版本的设备。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pVersionInfo</span> 用于设置检查版本的信息。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pCompatibility</span> 用于返回兼容性信息。</p></li>
</ul>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>需要激活 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructureFeaturesKHR::accelerationStructure</span></code> 特性。</p></li>
</ul>
</div>
</section>
<section id="vkaccelerationstructureversioninfokhr">
<h3>VkAccelerationStructureVersionInfoKHR<a class="headerlink" href="#vkaccelerationstructureversioninfokhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureVersionInfoKHR</span></code> 结构体定义如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VkAccelerationStructureVersionInfoKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VkStructureType</span><span class="w">    </span><span class="n">sType</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w">        </span><span class="n">pNext</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w">     </span><span class="n">pVersionData</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureVersionInfoKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">sType</span> 该结构体的类型，必须是 <code class="docutils literal notranslate"><span class="pre">VkStructureType::VK_STRUCTURE_TYPE_ACCELERATION_STRUCTURE_VERSION_INFO_KHR</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pNext</span> 要么是 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 要么指向其他结构体来扩展该结构体。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pVersionData</span> 指向 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureToMemoryKHR</span></code> 中定义的加速结构版本头。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">pVersionData</span></code> 指向一个 <span class="math notranslate nohighlight">\(2\times VK\_UUID\_SIZE\)</span> 的 <code class="docutils literal notranslate"><span class="pre">uint8_t</span></code> 的数组，而不是两个 <code class="docutils literal notranslate"><span class="pre">VK_UUID_SIZE</span></code> 数组。因为此成员的预期用例将指向内存中加载先前序列化的加速结构（通过vkCmdCopyAccelerationStructureToMemoryKHR或vkCopyAcceleration StructureToMemory KHR）的头部。使用数组将需要 <code class="docutils literal notranslate"><span class="pre">UUID</span></code> 的额外拷贝。<span class="sd-sphinx-override sd-badge sd-bg-danger sd-bg-text-danger">不知所云</span></p>
</div>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pVersionData</span></code> 必须是指向 <span class="math notranslate nohighlight">\(2\times VK\_UUID\_SIZE\)</span> 的 <code class="docutils literal notranslate"><span class="pre">uint8_t</span></code> 的数组。</p></li>
</ul>
</div>
</section>
<section id="vkaccelerationstructurecompatibilitykhr">
<h3>VkAccelerationStructureCompatibilityKHR<a class="headerlink" href="#vkaccelerationstructurecompatibilitykhr" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">pCompatibility</span></code> 可能的返回值如下：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">VkAccelerationStructureCompatibilityKHR</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">VK_ACCELERATION_STRUCTURE_COMPATIBILITY_COMPATIBLE_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">VK_ACCELERATION_STRUCTURE_COMPATIBILITY_INCOMPATIBLE_KHR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="n">VkAccelerationStructureCompatibilityKHR</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_ACCELERATION_STRUCTURE_COMPATIBILITY_COMPATIBLE_KHR</span> 表示 <code class="docutils literal notranslate"><span class="pre">pVersionData</span></code> 的加速结构版本与 <code class="docutils literal notranslate"><span class="pre">device</span></code> 兼容。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">VK_ACCELERATION_STRUCTURE_COMPATIBILITY_INCOMPATIBLE_KHR</span> 表示 <code class="docutils literal notranslate"><span class="pre">pVersionData</span></code> 的加速结构版本与 <code class="docutils literal notranslate"><span class="pre">device</span></code> 不兼容。</p></li>
</ul>
</section>
</section>
<section id="host">
<h2>加速结构的 Host 端操作<a class="headerlink" href="#host" title="Link to this heading">#</a></h2>
<p>如果驱动支持 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructureFeaturesKHR::accelerationStructureHostCommands</span></code> 特性的话，这说明对于加速结构支持在 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端进行操作。相关 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端操作函数与 <code class="docutils literal notranslate"><span class="pre">Device</span></code> 端操作函数对应如下：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vkBuildAccelerationStructuresKHR</span></code> 对应 <code class="docutils literal notranslate"><span class="pre">vkCmdBuildAccelerationStructuresKHR</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vkCopyAccelerationStructureKHR</span></code> 对应 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureKHR</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vkCopyAccelerationStructureToMemoryKHR</span></code> 对应 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureToMemoryKHR</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vkCopyMemoryToAccelerationStructureKHR</span></code> 对应 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyMemoryToAccelerationStructureKHR</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vkWriteAccelerationStructuresPropertiesKHR</span></code> 对应 <code class="docutils literal notranslate"><span class="pre">vkCmdWriteAccelerationStructuresPropertiesKHR</span></code></p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Host</span></code> 端操作函数与 <code class="docutils literal notranslate"><span class="pre">Device</span></code> 端操作函数在功能上是等价的，只不过是在 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端进行操作，而不是插入到命令缓存中（ <code class="docutils literal notranslate"><span class="pre">command</span> <span class="pre">buffers</span></code> ）。</p>
<p>所有 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端的加速结构必须将内存绑定到 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端可访问的内存上，并且加速结构构建时的所有输入数据必须使用 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端内存而不是 <code class="docutils literal notranslate"><span class="pre">Device</span></code> 端数据。当时用 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端的函数时不需要应用将加速结构的内存映射出来。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">vkBuildAccelerationStructuresKHR</span></code> 和 <code class="docutils literal notranslate"><span class="pre">vkCmdBuildAccelerationStructuresKHR</span></code> 也许会使用不同的算法，然而并没有要求这两个函数的结果需要完全相同。这两个函数可能会分别建立各自完全不同的内存或遍历性能，但是应该尽可能地尽量做到相似。</p>
<p>除了这些细节之外，<code class="docutils literal notranslate"><span class="pre">Host</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Device</span></code> 操作是可互换兼容的。比如可以使用 <code class="docutils literal notranslate"><span class="pre">vkBuildAccelerationStructuresKHR</span></code> 构建一个加速结构，之后可以使用 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureKHR</span></code> 将其进行压缩，并且使用 <code class="docutils literal notranslate"><span class="pre">vkCopyAccelerationStructureToMemoryKHR</span></code> 将加速结构进行序列化。</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>为了高效执行，由于驱动可能在指令执行期间反复的读写加速结构内存，所以操作这个加速结构的内存需要总是绑定到 <code class="docutils literal notranslate"><span class="pre">host</span> <span class="pre">cached</span></code> 内存上（ <code class="docutils literal notranslate"><span class="pre">VK_MEMORY_PROPERTY_HOST_CACHED_BIT</span></code> ）。</p>
</div>
<section id="id31">
<h3>vkBuildAccelerationStructuresKHR<a class="headerlink" href="#id31" title="Link to this heading">#</a></h3>
<p>在 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端构建一个加速结构调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="n">VkResult</span><span class="w"> </span><span class="nf">vkBuildAccelerationStructuresKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkDeferredOperationKHR</span><span class="w">                      </span><span class="n">deferredOperation</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w">                                    </span><span class="n">infoCount</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureBuildGeometryInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="n">pInfos</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureBuildRangeInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="n">ppBuildRangeInfos</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">device</span> 表示构建加速结构对应的 <code class="docutils literal notranslate"><span class="pre">VkDevice</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">deferredOperation</span> 是一个可选的 <code class="docutils literal notranslate"><span class="pre">VkDeferredOperationKHR</span></code> 句柄，为该指令申请延迟操作。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">infoCount</span> 表示要构建的加速结构数量。并表示 <code class="docutils literal notranslate"><span class="pre">pInfos</span></code> 和 <code class="docutils literal notranslate"><span class="pre">ppBuildRangeInfos</span></code> 需要提供的数量。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pInfos</span> 指向数量为 <code class="docutils literal notranslate"><span class="pre">infoCount</span></code> 类型为 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildGeometryInfoKHR</span></code> 结构体的数组，用于定义每一个要构建的加速结构。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">ppBuildRangeInfos</span> 指向数量为 <code class="docutils literal notranslate"><span class="pre">infoCount</span></code> 类型为 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildRangeInfoKHR</span></code> 结构体指针数组。，每一个 <code class="docutils literal notranslate"><span class="pre">ppBuildRangeInfos[i]</span></code> 都指向一个数量为 <code class="docutils literal notranslate"><span class="pre">pInfos[i].geometryCount</span></code> 类型为 <code class="docutils literal notranslate"><span class="pre">VkAccelerationStructureBuildRangeInfoKHR</span></code> 的结构体数组，用于对应 <code class="docutils literal notranslate"><span class="pre">pInfos[i]</span></code> 中几何数句的动态内存偏移。</p></li>
</ul>
<p>该函数的工作和 <code class="docutils literal notranslate"><span class="pre">vkCmdBuildAccelerationStructuresKHR</span></code> 函数一致，只不过执行在 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端上。</p>
<p><code class="docutils literal notranslate"><span class="pre">vkBuildAccelerationStructuresKHR</span></code> 支持一次性构建多个加速结构，然而构建与构建之间没有内置的顺序和同步。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>这也就意味着不能通过 <code class="docutils literal notranslate"><span class="pre">vkBuildAccelerationStructuresKHR</span></code> 函数调用同时构建底层加速结构和顶层加速结构。同样也不允许使用任何加速结构或暂付缓存的内存混叠。</p>
</div>
</section>
<section id="id32">
<h3>vkCopyAccelerationStructureKHR<a class="headerlink" href="#id32" title="Link to this heading">#</a></h3>
<p>在 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端拷贝和压缩加速结构，调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="n">VkResult</span><span class="w"> </span><span class="nf">vkCopyAccelerationStructureKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkDeferredOperationKHR</span><span class="w">                      </span><span class="n">deferredOperation</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkCopyAccelerationStructureInfoKHR</span><span class="o">*</span><span class="w">   </span><span class="n">pInfo</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">device</span> 表示构建加速结构对应的 <code class="docutils literal notranslate"><span class="pre">VkDevice</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">deferredOperation</span> 是一个可选的 <code class="docutils literal notranslate"><span class="pre">VkDeferredOperationKHR</span></code> 句柄，为该指令申请延迟操作。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pInfo</span> 指向用于定义拷贝操作的 <code class="docutils literal notranslate"><span class="pre">VkCopyAccelerationStructureInfoKHR</span></code> 结构体。</p></li>
</ul>
<p>该函数的工作和 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureKHR</span></code> 函数一致，只不过执行在 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端上。</p>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>需要激活 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructureFeaturesKHR::accelerationStructureHostCommands</span></code> 特性。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">deferredOperation</span></code> 不是 <code class="docutils literal notranslate"><span class="pre">VK_NULL_HANDLE</span></code> 的话，其必须是一个有效的 <code class="docutils literal notranslate"><span class="pre">VkDeferredOperationKHR</span></code> 句柄。</p></li>
<li><p>任何与 <code class="docutils literal notranslate"><span class="pre">deferredOperation</span></code> 相关的前操作都需要完成结束。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src</span></code> 的 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 必须绑定到 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端可访问的内存上。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst</span></code> 的 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 必须绑定到 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端可访问的内存上。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src</span></code> 的 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 必须绑定到没有分配多实体的内存上。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst</span></code> 的 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 必须绑定到没有分配多实体的内存上。</p></li>
</ul>
</div>
</section>
<section id="id33">
<h3>vkCopyMemoryToAccelerationStructureKHR<a class="headerlink" href="#id33" title="Link to this heading">#</a></h3>
<p>将 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端可访问的内存拷贝到加速结构中，调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="n">VkResult</span><span class="w"> </span><span class="nf">vkCopyMemoryToAccelerationStructureKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkDeferredOperationKHR</span><span class="w">                      </span><span class="n">deferredOperation</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkCopyMemoryToAccelerationStructureInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="n">pInfo</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">device</span> 表示构建加速结构对应的 <code class="docutils literal notranslate"><span class="pre">VkDevice</span></code> ，与 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst</span></code> 的设备相同。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">deferredOperation</span> 是一个可选的 <code class="docutils literal notranslate"><span class="pre">VkDeferredOperationKHR</span></code> 句柄，为该指令申请延迟操作。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pInfo</span> 指向用于定义拷贝操作的 <code class="docutils literal notranslate"><span class="pre">VkCopyMemoryToAccelerationStructureInfoKHR</span></code> 结构体。</p></li>
</ul>
<p>该函数的工作和 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyMemoryToAccelerationStructureKHR</span></code> 函数一致，只不过执行在 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端上。</p>
<p>该函数支持使用 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureToMemoryKHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">vkCopyAccelerationStructureToMemoryKHR</span></code> 的加速结构内存。</p>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>需要激活 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructureFeaturesKHR::accelerationStructureHostCommands</span></code> 特性。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">deferredOperation</span></code> 不是 <code class="docutils literal notranslate"><span class="pre">VK_NULL_HANDLE</span></code> 的话，其必须是一个有效的 <code class="docutils literal notranslate"><span class="pre">VkDeferredOperationKHR</span></code> 句柄。</p></li>
<li><p>任何与 <code class="docutils literal notranslate"><span class="pre">deferredOperation</span></code> 相关的前操作都需要完成结束。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src.hostAddress</span></code> 必须是一个有效的 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端指针。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst</span></code> 的 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 必须绑定到 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端可访问的内存上。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src.hostAddress</span></code> 必须 <code class="docutils literal notranslate"><span class="pre">16</span></code> 比特对齐。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst</span></code> 的 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 必须绑定到没有分配多实体的内存上。</p></li>
</ul>
</div>
</section>
<section id="id34">
<h3>vkCopyAccelerationStructureToMemoryKHR<a class="headerlink" href="#id34" title="Link to this heading">#</a></h3>
<p>将加速结构拷贝至 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端可访问的内存上，调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// 由 VK_KHR_acceleration_structure 提供</span>
<span class="n">VkResult</span><span class="w"> </span><span class="nf">vkCopyAccelerationStructureToMemoryKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkDeferredOperationKHR</span><span class="w">                      </span><span class="n">deferredOperation</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkCopyAccelerationStructureToMemoryInfoKHR</span><span class="o">*</span><span class="w"> </span><span class="n">pInfo</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">device</span> 表示构建加速结构对应的 <code class="docutils literal notranslate"><span class="pre">VkDevice</span></code> ，与 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src</span></code> 的设备相同。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">deferredOperation</span> 是一个可选的 <code class="docutils literal notranslate"><span class="pre">VkDeferredOperationKHR</span></code> 句柄，为该指令申请延迟操作。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pInfo</span> 指向用于定义拷贝操作的 <code class="docutils literal notranslate"><span class="pre">VkCopyAccelerationStructureToMemoryInfoKHR</span></code> 结构体。</p></li>
</ul>
<p>该函数的工作和 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureToMemoryKHR</span></code> 函数一致，只不过执行在 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端上。</p>
<p>该函数与 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyAccelerationStructureToMemoryKHR</span></code> 结果相同，只不过直接将结果写入 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端指针指向的内存上，并执行在 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端上而不是 <code class="docutils literal notranslate"><span class="pre">Device</span></code> 端。每次输出的结果并不一定每一个比特都相等，但都可以被 <code class="docutils literal notranslate"><span class="pre">vkCmdCopyMemoryToAccelerationStructureKHR</span></code> 或 <code class="docutils literal notranslate"><span class="pre">vkCopyMemoryToAccelerationStructureKHR</span></code> 使用。</p>
<div class="note admonition">
<p class="admonition-title">正确用法</p>
<ul class="simple">
<li><p>需要激活 <code class="docutils literal notranslate"><span class="pre">VkPhysicalDeviceAccelerationStructureFeaturesKHR::accelerationStructureHostCommands</span></code> 特性。</p></li>
<li><p>如果 <code class="docutils literal notranslate"><span class="pre">deferredOperation</span></code> 不是 <code class="docutils literal notranslate"><span class="pre">VK_NULL_HANDLE</span></code> 的话，其必须是一个有效的 <code class="docutils literal notranslate"><span class="pre">VkDeferredOperationKHR</span></code> 句柄。</p></li>
<li><p>任何与 <code class="docutils literal notranslate"><span class="pre">deferredOperation</span></code> 相关的前操作都需要完成结束。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src</span></code> 的 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 必须绑定到 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端可访问的内存上。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst.hostAddress</span></code> 必须是有效的 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 指针。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;dst.hostAddress</span></code> 必须 <code class="docutils literal notranslate"><span class="pre">16</span></code> 比特对齐。</p></li>
<li><p>用于 <code class="docutils literal notranslate"><span class="pre">pInfo-&gt;src</span></code> 的 <code class="docutils literal notranslate"><span class="pre">buffer</span></code> 必须绑定到没有分配多实体的内存上。</p></li>
</ul>
</div>
</section>
<section id="id35">
<h3>vkWriteAccelerationStructuresPropertiesKHR<a class="headerlink" href="#id35" title="Link to this heading">#</a></h3>
<p>在 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端查询加速结构大小，调用：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Provided by VK_KHR_acceleration_structure</span>
<span class="n">VkResult</span><span class="w"> </span><span class="nf">vkWriteAccelerationStructuresPropertiesKHR</span><span class="p">(</span>
<span class="w">    </span><span class="n">VkDevice</span><span class="w">                                    </span><span class="n">device</span><span class="p">,</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w">                                    </span><span class="n">accelerationStructureCount</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">VkAccelerationStructureKHR</span><span class="o">*</span><span class="w">           </span><span class="n">pAccelerationStructures</span><span class="p">,</span>
<span class="w">    </span><span class="n">VkQueryType</span><span class="w">                                 </span><span class="n">queryType</span><span class="p">,</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w">                                      </span><span class="n">dataSize</span><span class="p">,</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w">                                       </span><span class="n">pData</span><span class="p">,</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w">                                      </span><span class="n">stride</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">device</span> 表示拥有 <code class="docutils literal notranslate"><span class="pre">pAccelerationStructures</span></code> 加速结构对应的 <code class="docutils literal notranslate"><span class="pre">VkDevice</span></code> 。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">accelerationStructureCount</span> 表示要查询的加速结构的数量。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pAccelerationStructures</span> 用于指向之前构建的加速结构数组。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">queryType</span> 是 <code class="docutils literal notranslate"><span class="pre">VkQueryType</span></code> 值用于设置查询类型。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">dataSize</span> 是 <code class="docutils literal notranslate"><span class="pre">pData</span></code> 中数据的比特大小。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">pData</span> 指向用户分配的缓存用于写入结果。</p></li>
<li><p><span class="sd-sphinx-override sd-badge sd-bg-secondary sd-bg-text-secondary">stride</span> 指向这是写入的每个结果之间的跨度。</p></li>
</ul>
<p>该函数的工作和 <code class="docutils literal notranslate"><span class="pre">vkCmdWriteAccelerationStructuresPropertiesKHR</span></code> 函数一致，只不过执行在 <code class="docutils literal notranslate"><span class="pre">Host</span></code> 端上。</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
<div class="related-pages">
    <a class="next-page" href="VK_KHR_ray_tracing_pipeline.html">
        <div class="page-info">
            <div class="context">
                <span>Next</span>
            </div>
            <div class="title">VK_KHR_ray_tracing_pipeline</div>
        </div>
        <svg class="furo-related-icon">
            <use href="#svg-arrow-right"></use>
        </svg>
    </a>
    <a class="prev-page" href="VulkanKHRRayTracing.html">
        <svg class="furo-related-icon">
            <use href="#svg-arrow-right"></use>
        </svg>
        <div class="page-info">
            <div class="context">
                <span>Previous</span>
            </div>
            
            <div class="title">Vulkan KHR 光线追踪标准</div>
            
        </div>
    </a>
</div>
<div class="bottom-of-page">
    <div class="left-details">
        <div class="copyright">
            Copyright &#169; 2023, FuXii
        </div>
        Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
        
        <a href="https://github.com/pradyunsg/furo">Furo</a>
        
        <div>
             <span id="busuanzi_container_site_uv" style='display:none'>site view <span
                    id="busuanzi_value_site_uv"></span></span> 
        </div>
    </div>
    <div class="right-details">
        <div class="icons">
            <a class="muted-link " href="https://github.com/FuXiii/Essentials.of.Vulkan" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
            
        </div>
        <div class="left-details">
             <span id="busuanzi_container_page_pv" style='display:none'>page view <span
                    id="busuanzi_value_page_pv"></span></span> 
        </div>
    </div>
</div>

      </footer>
    </div>
    <aside class="toc-drawer">
      

<div class="toc-sticky toc-scroll" style="width: 500px;">
    <div class="toc-title-container" style="width: 500px;">
        <span class="toc-title" style="width: 500px;">
            On this page
        </span>
    </div>
    <div class="toc-tree-container" style="width: 500px;">
        <div class="toc-tree" style="width: 500px;">
            <ul>
<li><a class="reference internal" href="#">VK_KHR_acceleration_structure</a><ul>
<li><a class="reference internal" href="#id3">查看是否支持加速结构特性</a><ul>
<li><a class="reference internal" href="#id4">例程</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">激活加速结构特性</a><ul>
<li><a class="reference internal" href="#id6">例程</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id7">获取缓存的设备地址</a><ul>
<li><a class="reference internal" href="#vkgetbufferdeviceaddress">vkGetBufferDeviceAddress</a></li>
<li><a class="reference internal" href="#vkgetbufferdeviceaddresskhr">vkGetBufferDeviceAddressKHR</a></li>
<li><a class="reference internal" href="#vkbufferdeviceaddressinfo">VkBufferDeviceAddressInfo</a></li>
<li><a class="reference internal" href="#vkbufferdeviceaddressinfokhr">VkBufferDeviceAddressInfoKHR</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8">加速结构</a><ul>
<li><a class="reference internal" href="#id9">几何体</a></li>
<li><a class="reference internal" href="#id10">顶层加速结构</a></li>
<li><a class="reference internal" href="#id11">底层加速结构</a></li>
<li><a class="reference internal" href="#id12">加速结构的更新规则</a></li>
<li><a class="reference internal" href="#id13">无效的图元和实体</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id14">加速结构的描述</a><ul>
<li><a class="reference internal" href="#vkaccelerationstructurebuildgeometryinfokhr">VkAccelerationStructureBuildGeometryInfoKHR</a></li>
<li><a class="reference internal" href="#vkbuildaccelerationstructureflagbitskhr">VkBuildAccelerationStructureFlagBitsKHR</a></li>
<li><a class="reference internal" href="#vkbuildaccelerationstructuremodekhr">VkBuildAccelerationStructureModeKHR</a></li>
<li><a class="reference internal" href="#vkdeviceorhostaddresskhr">VkDeviceOrHostAddressKHR</a></li>
<li><a class="reference internal" href="#vkdeviceorhostaddressconstkhr">VkDeviceOrHostAddressConstKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructuregeometrykhr">VkAccelerationStructureGeometryKHR</a></li>
<li><a class="reference internal" href="#vkgeometrytypekhr">VkGeometryTypeKHR</a></li>
<li><a class="reference internal" href="#vkgeometryflagbitskhr">VkGeometryFlagBitsKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructuregeometrydatakhr">VkAccelerationStructureGeometryDataKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructuregeometrytrianglesdatakhr">VkAccelerationStructureGeometryTrianglesDataKHR</a></li>
<li><a class="reference internal" href="#vktransformmatrixkhr">VkTransformMatrixKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructuregeometryaabbsdatakhr">VkAccelerationStructureGeometryAabbsDataKHR</a></li>
<li><a class="reference internal" href="#vkaabbpositionskhr">VkAabbPositionsKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructuregeometryinstancesdatakhr">VkAccelerationStructureGeometryInstancesDataKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructureinstancekhr">VkAccelerationStructureInstanceKHR</a></li>
<li><a class="reference internal" href="#vkgeometryinstanceflagbitskhr">VkGeometryInstanceFlagBitsKHR</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id15">获取加速结构的构建大小</a><ul>
<li><a class="reference internal" href="#id16">vkGetAccelerationStructureBuildSizesKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructurebuildtypekhr">VkAccelerationStructureBuildTypeKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructurebuildsizesinfokhr">VkAccelerationStructureBuildSizesInfoKHR</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id17">创建加速结构</a><ul>
<li><a class="reference internal" href="#id18">vkCreateAccelerationStructureKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructurecreateinfokhr">VkAccelerationStructureCreateInfoKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructuretypekhr">VkAccelerationStructureTypeKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructurecreateflagbitskhr">VkAccelerationStructureCreateFlagBitsKHR</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id19">获取64位加速结构设备地址</a><ul>
<li><a class="reference internal" href="#id20">vkGetAccelerationStructureDeviceAddressKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructuredeviceaddressinfokhr">VkAccelerationStructureDeviceAddressInfoKHR</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id21">销毁加速结构</a><ul>
<li><a class="reference internal" href="#id22">vkDestroyAccelerationStructureKHR</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id23">构建加速结构</a><ul>
<li><a class="reference internal" href="#id24">vkCmdBuildAccelerationStructuresKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructurebuildrangeinfokhr">VkAccelerationStructureBuildRangeInfoKHR</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id25">拷贝加速结构</a><ul>
<li><a class="reference internal" href="#id26">vkCmdWriteAccelerationStructuresPropertiesKHR</a></li>
<li><a class="reference internal" href="#id27">vkCmdCopyAccelerationStructureKHR</a></li>
<li><a class="reference internal" href="#vkcopyaccelerationstructureinfokhr">VkCopyAccelerationStructureInfoKHR</a></li>
<li><a class="reference internal" href="#id28">vkCmdCopyAccelerationStructureToMemoryKHR</a></li>
<li><a class="reference internal" href="#vkcopyaccelerationstructuretomemoryinfokhr">VkCopyAccelerationStructureToMemoryInfoKHR</a></li>
<li><a class="reference internal" href="#id29">vkCmdCopyMemoryToAccelerationStructureKHR</a></li>
<li><a class="reference internal" href="#vkcopymemorytoaccelerationstructureinfokhr">VkCopyMemoryToAccelerationStructureInfoKHR</a></li>
<li><a class="reference internal" href="#id30">vkGetDeviceAccelerationStructureCompatibilityKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructureversioninfokhr">VkAccelerationStructureVersionInfoKHR</a></li>
<li><a class="reference internal" href="#vkaccelerationstructurecompatibilitykhr">VkAccelerationStructureCompatibilityKHR</a></li>
</ul>
</li>
<li><a class="reference internal" href="#host">加速结构的 Host 端操作</a><ul>
<li><a class="reference internal" href="#id31">vkBuildAccelerationStructuresKHR</a></li>
<li><a class="reference internal" href="#id32">vkCopyAccelerationStructureKHR</a></li>
<li><a class="reference internal" href="#id33">vkCopyMemoryToAccelerationStructureKHR</a></li>
<li><a class="reference internal" href="#id34">vkCopyAccelerationStructureToMemoryKHR</a></li>
<li><a class="reference internal" href="#id35">vkWriteAccelerationStructuresPropertiesKHR</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
    </div>
</div>


    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=7d86a446"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/tabs.js?v=3ee01567"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script src="../../_static/translations.js?v=beaddf03"></script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    </body>
</html>